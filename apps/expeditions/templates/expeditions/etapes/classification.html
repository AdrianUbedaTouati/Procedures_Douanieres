{% extends 'core/base.html' %}

{% block title %}Classification - {{ expedition.reference }}{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       Upload Zones
    ============================================ */
    .upload-zone {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 120px;
    }
    .upload-zone:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .upload-zone.dragover {
        border-color: #0d6efd;
        background-color: #e7f1ff;
    }
    .upload-zone.zone-photos {
        border-color: #0d6efd;
    }
    .upload-zone.zone-documents {
        border-color: #dc3545;
    }

    /* ============================================
       Documents
    ============================================ */
    .document-item {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease;
    }
    .document-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .document-item.sortable-ghost {
        opacity: 0.4;
        background: #e7f1ff;
    }
    .document-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
        margin-right: 10px;
    }
    .document-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-radius: 6px;
        margin-right: 10px;
        font-size: 1.3rem;
    }
    .document-info {
        flex: 1;
        min-width: 0;
    }
    .document-name {
        font-weight: 500;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .document-actions .btn {
        padding: 3px 6px;
        font-size: 0.8rem;
    }
    .drag-handle {
        cursor: grab;
        padding: 5px;
        color: #adb5bd;
        margin-right: 5px;
    }
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .section-count {
        background: #e9ecef;
        padding: 2px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
    }
    .file-preview-list {
        max-height: 150px;
        overflow-y: auto;
    }
    .file-preview-item {
        display: flex;
        align-items: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 6px;
        font-size: 0.85rem;
        border: 1px solid #dee2e6;
    }
    .file-preview-item .file-thumb {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 10px;
    }
    .file-preview-item .file-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border-radius: 4px;
        margin-right: 10px;
        font-size: 1.2rem;
    }
    .file-preview-item .file-info {
        flex: 1;
        min-width: 0;
    }
    .file-preview-item .file-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }
    .file-preview-item .file-name-input {
        width: 100%;
        border: 1px solid #0d6efd;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 0.85rem;
    }
    .file-preview-item .file-size {
        font-size: 0.75rem;
        color: #6c757d;
    }
    .file-preview-item .file-actions {
        display: flex;
        gap: 4px;
    }
    .file-preview-item .btn-remove {
        padding: 2px 6px;
        font-size: 0.75rem;
    }

    /* Image preview modal */
    .image-preview-modal .modal-body {
        text-align: center;
        padding: 0;
    }
    .image-preview-modal .modal-body img {
        max-width: 100%;
        max-height: 80vh;
    }

    /* ============================================
       Chat Container
    ============================================ */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 250px);
        min-height: 500px;
        max-height: 700px;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .chat-input-container {
        padding: 15px;
        background: #fff;
        border-top: 1px solid #dee2e6;
    }

    /* ============================================
       Chat Messages
    ============================================ */
    .message {
        margin-bottom: 15px;
        display: flex;
    }
    .message.user {
        justify-content: flex-end;
    }
    .message.assistant {
        justify-content: flex-start;
    }
    .message-bubble {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
    }
    .message.user .message-bubble {
        background: #0d6efd;
        color: white;
        border-bottom-right-radius: 4px;
    }
    .message.assistant .message-bubble {
        background: white;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 4px;
    }
    .message.system .message-bubble {
        background: #d1e7dd;
        color: #0f5132;
        width: 100%;
        max-width: 100%;
        text-align: center;
        border-radius: 8px;
    }
    .message-time {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 4px;
    }
    .message.user .message-time {
        text-align: right;
        color: rgba(255,255,255,0.7);
    }

    /* ============================================
       TARIC Proposals - Compact inline style
    ============================================ */
    .proposals-inline {
        margin-top: 15px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #dee2e6;
    }
    .proposals-header {
        font-size: 0.85rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .proposal-btn {
        display: block;
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }
    .proposal-btn:hover {
        border-color: #0d6efd;
        background: #f0f7ff;
    }
    .proposal-btn.selected {
        border-color: #198754;
        background: #d1e7dd;
        box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.25);
    }
    .proposal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    .proposal-btn .code {
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        font-weight: bold;
        color: #0d6efd;
        background: #e7f1ff;
        padding: 2px 8px;
        border-radius: 4px;
    }
    .proposal-btn .probability-badge {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.75rem;
    }
    .probability-badge.high { background: #d1e7dd; color: #0f5132; }
    .probability-badge.medium { background: #fff3cd; color: #664d03; }
    .probability-badge.low { background: #f8d7da; color: #842029; }
    .proposal-details {
        font-size: 0.8rem;
        color: #495057;
        margin: 4px 0;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .proposal-taxes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed #dee2e6;
    }
    .proposal-tax {
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 0.75rem;
    }
    .proposal-tax i {
        color: #6c757d;
        font-size: 0.7rem;
    }
    .proposal-tax .tax-label {
        color: #6c757d;
    }
    .proposal-tax .tax-value {
        font-weight: 600;
        color: #212529;
    }
    .proposal-tax .tax-value.tax-zero {
        color: #198754;
    }
    .proposal-tax .btn-sm {
        padding: 1px 6px;
        font-size: 0.7rem;
    }

    /* ============================================
       Summary Section
    ============================================ */
    .summary-section {
        margin-top: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #d1e7dd 0%, #badbcc 100%);
        border-radius: 12px;
        border: 1px solid #198754;
    }
    .summary-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .summary-header i {
        font-size: 1.5rem;
        color: #198754;
    }
    .summary-code {
        font-family: monospace;
        font-size: 1.8rem;
        font-weight: bold;
        color: #0d6efd;
    }
    .summary-details {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
    }

    /* ============================================
       Typing Indicator
    ============================================ */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 10px 15px;
    }
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #6c757d;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }

    /* ============================================
       Validate Button
    ============================================ */
    .validate-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }

    /* ============================================
       Tools Used Section
    ============================================ */
    .tools-used {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px dashed #dee2e6;
        font-size: 0.75rem;
    }
    .tools-used-header {
        color: #6c757d;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .tools-used-header:hover {
        color: #0d6efd;
    }
    .tools-used-header i {
        font-size: 0.65rem;
        transition: transform 0.2s;
    }
    .tools-used-header.collapsed i {
        transform: rotate(-90deg);
    }
    .tools-used-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
    }
    .tool-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 6px;
        background: #e7f1ff;
        color: #0d6efd;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    .tool-badge.tool-web_search {
        background: #fff3cd;
        color: #856404;
    }
    .tool-badge.tool-browse_webpage {
        background: #d1e7dd;
        color: #0f5132;
    }
    .tool-badge.tool-fetch_pdf {
        background: #f8d7da;
        color: #842029;
    }
    .tool-badge.tool-guardar_pdf_expediente {
        background: #cff4fc;
        color: #055160;
    }
    .tool-badge.tool-get_expedition_documents {
        background: #e2e3e5;
        color: #41464b;
    }
    .tool-badge.tool-analyze_documents {
        background: #d3d3f5;
        color: #432874;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'apps_expeditions:list' %}">Expeditions</a></li>
            <li class="breadcrumb-item"><a href="{% url 'apps_expeditions:detail' expedition.pk %}">{{ expedition.reference }}</a></li>
            <li class="breadcrumb-item active">Classification</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-3">
        <div class="col-md-8">
            <h1 class="h3">
                <i class="bi bi-tags text-primary"></i> Etape 1: Classification Douaniere
            </h1>
            <p class="text-muted mb-0">{{ expedition.nom_article }}</p>
        </div>
        <div class="col-md-4 text-end">
            {% if etape.statut == 'en_cours' %}
                <span class="badge bg-primary fs-6">En cours</span>
            {% elif etape.statut == 'termine' %}
                <span class="badge bg-success fs-6">Termine</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Colonne gauche: Documents -->
        <div class="col-lg-5 col-xl-4 mb-4">
            <!-- Section Photos -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white py-2">
                    <i class="bi bi-camera"></i> Photos du produit
                </div>
                <div class="card-body py-2">
                    {% if etape_terminee %}
                    <div class="alert alert-info mb-2 py-2 small">
                        <i class="bi bi-lock"></i> Lecture seule - etape terminee
                    </div>
                    {% else %}
                    <form id="uploadPhotosForm" method="post" enctype="multipart/form-data"
                          action="{% url 'apps_expeditions:classification_upload' expedition.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="type_document" value="photo">
                        <div class="upload-zone zone-photos mb-2" id="dropZonePhotos">
                            <i class="bi bi-images display-6 text-primary"></i>
                            <p class="mb-0 mt-1 small">Glissez vos photos ici</p>
                            <input type="file" name="fichier" id="fileInputPhotos" class="d-none" accept="image/*" multiple>
                        </div>
                        <div id="filePreviewPhotos" class="file-preview-list mb-2 d-none"></div>
                        <button type="submit" class="btn btn-primary btn-sm w-100" id="uploadBtnPhotos" disabled>
                            <i class="bi bi-upload"></i> Telecharger
                        </button>
                    </form>
                    {% endif %}

                    {% if photos %}
                    <hr class="my-2">
                    <div class="section-header">
                        <small class="fw-bold"><i class="bi bi-images"></i> Photos</small>
                        <span class="section-count">{{ photos.count }}</span>
                    </div>
                    <div id="photosContainer" data-type="photo" style="max-height: 200px; overflow-y: auto;">
                        {% for doc in photos %}
                        <div class="document-item" data-id="{{ doc.id }}">
                            {% if not etape_terminee %}<i class="bi bi-grip-vertical drag-handle"></i>{% endif %}
                            {% if doc.is_image %}
                            <img src="{{ doc.fichier.url }}" alt="{{ doc.nom_original }}" class="document-thumb">
                            {% else %}
                            <div class="document-icon text-primary"><i class="bi bi-image"></i></div>
                            {% endif %}
                            <div class="document-info">
                                <div class="document-name" title="{{ doc.nom_original }}">{{ doc.nom_original }}</div>
                            </div>
                            <div class="document-actions">
                                <button type="button" class="btn btn-outline-primary btn-sm btn-preview-img" data-url="{{ doc.fichier.url }}" data-name="{{ doc.nom_original }}" title="Agrandir">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                                {% if not etape_terminee %}
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-rename" data-id="{{ doc.id }}" data-name="{{ doc.nom_original }}" title="Renommer">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm btn-delete" data-id="{{ doc.id }}" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Section Fiches Techniques -->
            <div class="card">
                <div class="card-header bg-danger text-white py-2">
                    <i class="bi bi-file-pdf"></i> Fiches techniques
                </div>
                <div class="card-body py-2">
                    {% if not etape_terminee %}
                    <form id="uploadDocsForm" method="post" enctype="multipart/form-data"
                          action="{% url 'apps_expeditions:classification_upload' expedition.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="type_document" value="fiche_technique">
                        <div class="upload-zone zone-documents mb-2" id="dropZoneDocs">
                            <i class="bi bi-file-earmark-pdf display-6 text-danger"></i>
                            <p class="mb-0 mt-1 small">Glissez vos PDF ici</p>
                            <input type="file" name="fichier" id="fileInputDocs" class="d-none" accept=".pdf,application/pdf" multiple>
                        </div>
                        <div id="filePreviewDocs" class="file-preview-list mb-2 d-none"></div>
                        <button type="submit" class="btn btn-danger btn-sm w-100" id="uploadBtnDocs" disabled>
                            <i class="bi bi-upload"></i> Telecharger
                        </button>
                    </form>
                    {% endif %}

                    {% if fiches_techniques %}
                    <hr class="my-2">
                    <div class="section-header">
                        <small class="fw-bold"><i class="bi bi-file-pdf"></i> Documents</small>
                        <span class="section-count">{{ fiches_techniques.count }}</span>
                    </div>
                    <div id="docsContainer" data-type="fiche_technique" style="max-height: 200px; overflow-y: auto;">
                        {% for doc in fiches_techniques %}
                        <div class="document-item" data-id="{{ doc.id }}">
                            {% if not etape_terminee %}<i class="bi bi-grip-vertical drag-handle"></i>{% endif %}
                            <div class="document-icon text-danger"><i class="bi bi-file-pdf"></i></div>
                            <div class="document-info">
                                <div class="document-name" title="{{ doc.nom_original }}">{{ doc.nom_original }}</div>
                            </div>
                            <div class="document-actions">
                                <a href="{{ doc.fichier.url }}" target="_blank" class="btn btn-outline-info btn-sm" title="Voir">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if not etape_terminee %}
                                <button type="button" class="btn btn-outline-secondary btn-sm btn-rename" data-id="{{ doc.id }}" data-name="{{ doc.nom_original }}" title="Renommer">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm btn-delete" data-id="{{ doc.id }}" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Documents web (descargados por el agente IA) -->
            <div class="card mt-3" id="webDocumentsCard">
                <div class="card-header bg-info text-white py-2">
                    <i class="bi bi-globe"></i> Documents trouvés par l'IA
                    <span class="badge bg-light text-dark ms-1" id="webDocsCount">{{ web_documents.count|default:0 }}</span>
                </div>
                <div class="card-body py-2">
                    <div id="webDocumentsContainer" style="max-height: 250px; overflow-y: auto;">
                        {% if web_documents %}
                        {% for doc in web_documents %}
                        <div class="web-document-item mb-2 p-2 border rounded bg-light" data-id="{{ doc.id }}">
                            <div class="d-flex align-items-start">
                                <div class="me-2 text-info">
                                    <i class="bi bi-file-earmark-pdf-fill fs-4"></i>
                                </div>
                                <div class="flex-grow-1 min-width-0">
                                    <div class="fw-bold text-truncate" title="{{ doc.titulo }}">{{ doc.titulo }}</div>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-link-45deg"></i> {{ doc.dominio_origen }}
                                        <span class="mx-1">|</span>
                                        <i class="bi bi-file-earmark"></i> {{ doc.tamano_legible }}
                                        {% if doc.paginas %}<span class="mx-1">|</span> {{ doc.paginas }} pages{% endif %}
                                    </small>
                                    {% if doc.razon_guardado %}
                                    <small class="text-success d-block mt-1">
                                        <i class="bi bi-check-circle"></i> {{ doc.razon_guardado|truncatewords:15 }}
                                    </small>
                                    {% endif %}
                                </div>
                                <div class="ms-2">
                                    <a href="{{ doc.fichier.url }}" target="_blank" class="btn btn-info btn-sm" title="Voir le PDF">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ doc.fichier.url }}" download class="btn btn-outline-info btn-sm" title="Télécharger">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-3" id="webDocsEmpty">
                            <i class="bi bi-inbox fs-3"></i>
                            <p class="mb-0 small">L'assistant n'a pas encore trouvé de documents pertinents.</p>
                            <p class="mb-0 small text-info">Les documents utiles apparaîtront ici.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Bouton retour -->
            <div class="mt-3">
                <a href="{% url 'apps_expeditions:detail' expedition.pk %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
            </div>
        </div>

        <!-- Colonne droite: Chat -->
        <div class="col-lg-7 col-xl-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white py-2">
                    <i class="bi bi-robot"></i> Assistant Classification TARIC
                    {% if etape_terminee %}
                    <span class="badge bg-light text-dark ms-2">Lecture seule</span>
                    {% endif %}
                </div>
                <div class="card-body p-0 chat-container">
                    <!-- Zone des messages -->
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages charges dynamiquement -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="text-muted mt-2">Chargement du chat...</p>
                        </div>

                        <!-- Zone des propositions TARIC (DANS le scroll des messages) -->
                        <div id="proposalsSection" class="d-none proposals-inline">
                            <div class="proposals-header">
                                <i class="bi bi-list-check"></i> Selectionnez un code TARIC :
                            </div>
                            <div id="proposalsContainer"></div>
                            <div class="validate-section" id="validateSection" style="display: none;">
                                <button type="button" class="btn btn-success btn-sm w-100" id="validateBtn">
                                    <i class="bi bi-check-lg"></i> Valider cette classification
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Zone de saisie -->
                    <div class="chat-input-container" id="chatInputContainer">
                        {% if not etape_terminee %}
                        <!-- Mode Initial: Analyse automatique -->
                        <div id="analyzeMode">
                            <div class="mb-2">
                                <textarea class="form-control" id="analyzeContext" rows="2"
                                    placeholder="(Optionnel) Ajoutez des informations sur le produit..."></textarea>
                            </div>
                            <button type="button" class="btn btn-success w-100" id="analyzeBtn">
                                <i class="bi bi-cpu"></i> Analyser les documents
                            </button>
                            <small class="text-muted d-block text-center mt-1">
                                L'assistant analysera automatiquement vos photos et fiches techniques
                            </small>
                        </div>
                        <!-- Mode Chat: Messages normaux (cache initialement) -->
                        <form id="chatForm" class="d-none gap-2">
                            <input type="text" class="form-control" id="chatInput"
                                   placeholder="Posez votre question..." autocomplete="off">
                            <button type="submit" class="btn btn-success" id="sendBtn">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                        {% else %}
                        <div class="text-center text-muted py-2">
                            <i class="bi bi-lock"></i> Chat en lecture seule
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Resume (affiche apres validation) -->
                <div id="summarySection" class="d-none">
                    <div class="summary-section mx-3 mb-3">
                        <div class="summary-header">
                            <i class="bi bi-check-circle-fill"></i>
                            <div>
                                <h5 class="mb-0">Classification Validee</h5>
                                <div class="summary-code" id="summaryCode"></div>
                            </div>
                        </div>
                        <div class="summary-details">
                            <div id="summaryContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Supprimer -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-trash"></i> Supprimer le document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Etes-vous sur de vouloir supprimer ce document ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Renommer -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Renommer le document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newDocName" class="form-label">Nouveau nom</label>
                    <input type="text" class="form-control" id="newDocName" placeholder="Entrez le nouveau nom">
                    <div class="form-text">L'extension sera conservee automatiquement.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmRename">Renommer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview Image -->
<div class="modal fade image-preview-modal" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="imagePreviewTitle">Image</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <img id="imagePreviewImg" src="" alt="Preview">
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmation Validation -->
<div class="modal fade" id="validateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-shield-check"></i> Confirmer la classification</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-center mb-3">Vous allez valider le code TARIC suivant :</p>

                <!-- Code TARIC principal -->
                <div class="text-center my-4">
                    <div class="d-inline-block px-4 py-3 rounded-3" style="background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%); border: 2px solid #0d6efd;">
                        <span class="font-monospace fs-3 fw-bold text-primary" id="modalCode"></span>
                    </div>
                </div>

                <!-- Description -->
                <p id="modalDescription" class="text-center text-muted mb-3"></p>

                <!-- Details taxes -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded text-center">
                            <small class="text-muted d-block">Droits de douane</small>
                            <span class="fs-5 fw-bold" id="modalDroits">-</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded text-center">
                            <small class="text-muted d-block">TVA</small>
                            <span class="fs-5 fw-bold" id="modalTVA">-</span>
                        </div>
                    </div>
                </div>

                <!-- Probabilite -->
                <div class="text-center mb-3">
                    <span class="badge bg-secondary fs-6" id="modalProbability"></span>
                </div>

                <!-- Lien vers tarifdouanier.eu -->
                <div class="text-center mb-3">
                    <a href="#" target="_blank" class="btn btn-outline-info" id="modalTaricLink">
                        <i class="bi bi-box-arrow-up-right"></i> Plus d'infos sur tarifdouanier.eu
                    </a>
                </div>

                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Attention :</strong> Une fois validee, cette etape sera verrouillee. Vous pourrez consulter les informations mais pas les modifier.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Annuler
                </button>
                <button type="button" class="btn btn-success btn-lg" id="confirmValidate">
                    <i class="bi bi-check-lg"></i> Oui, valider cette classification
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// VERSION: 2026-01-06-v4 - Fix proposals loading from API root level
document.addEventListener('DOMContentLoaded', function() {
    console.log('[TARIC CHAT] Script version 2026-01-06-v4 loaded');
    const expeditionPk = {{ expedition.pk }};
    const csrfToken = '{{ csrf_token }}';
    const etapeTerminee = {{ etape_terminee|yesno:"true,false" }};

    // Elements du chat
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const proposalsSection = document.getElementById('proposalsSection');
    const proposalsContainer = document.getElementById('proposalsContainer');
    const validateSection = document.getElementById('validateSection');
    const validateBtn = document.getElementById('validateBtn');
    const summarySection = document.getElementById('summarySection');

    // Elements du mode analyse (initial)
    const analyzeMode = document.getElementById('analyzeMode');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeContext = document.getElementById('analyzeContext');

    let selectedProposalId = null;
    let selectedProposalData = null;
    let latestProposals = [];

    // ============================================
    // Upload Zones Setup
    // ============================================
    setupUploadZone('Photos', 'fileInputPhotos', 'dropZonePhotos', 'filePreviewPhotos', 'uploadBtnPhotos', 'photos');
    setupUploadZone('Docs', 'fileInputDocs', 'dropZoneDocs', 'filePreviewDocs', 'uploadBtnDocs', 'docs');

    function setupUploadZone(suffix, inputId, dropId, previewId, btnId, type) {
        const dropZone = document.getElementById(dropId);
        const fileInput = document.getElementById(inputId);
        const filePreview = document.getElementById(previewId);
        const uploadBtn = document.getElementById(btnId);

        if (!dropZone || !fileInput) return;

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                showMultiplePreview(fileInput.files, filePreview, uploadBtn, type);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                showMultiplePreview(e.target.files, filePreview, uploadBtn, type);
            }
        });
    }

    // Store files to upload with custom names
    let filesToUpload = { photos: [], docs: [] };

    function showMultiplePreview(files, previewContainer, uploadBtn, type) {
        const fileArray = Array.from(files);
        const storageKey = type === 'photos' ? 'photos' : 'docs';

        // ACUMULAR archivos en lugar de reemplazar
        const newFiles = fileArray.map(f => ({ file: f, customName: f.name }));
        filesToUpload[storageKey] = [...filesToUpload[storageKey], ...newFiles];

        // Re-renderizar toda la lista
        renderFilePreviewList(previewContainer, uploadBtn, type, storageKey);
    }

    function renderFilePreviewList(previewContainer, uploadBtn, type, storageKey) {
        previewContainer.innerHTML = '';

        if (filesToUpload[storageKey].length === 0) {
            previewContainer.classList.add('d-none');
            updateUploadButton(uploadBtn, 0);
            return;
        }

        previewContainer.classList.remove('d-none');

        filesToUpload[storageKey].forEach((fileObj, index) => {
            const file = fileObj.file;
            const item = document.createElement('div');
            item.className = 'file-preview-item';
            item.dataset.index = index;

            // Thumbnail or icon
            if (file.type.startsWith('image/')) {
                const thumb = document.createElement('img');
                thumb.className = 'file-thumb';
                thumb.src = URL.createObjectURL(file);
                item.appendChild(thumb);
            } else {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'file-icon text-danger';
                iconDiv.innerHTML = '<i class="bi bi-file-pdf"></i>';
                item.appendChild(iconDiv);
            }

            // File info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'file-info';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'file-name';
            nameDiv.textContent = fileObj.customName;
            nameDiv.title = fileObj.customName;

            const sizeDiv = document.createElement('div');
            sizeDiv.className = 'file-size';
            sizeDiv.textContent = formatFileSize(file.size);

            infoDiv.appendChild(nameDiv);
            infoDiv.appendChild(sizeDiv);
            item.appendChild(infoDiv);

            // Actions
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'file-actions';

            // Edit name button
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn btn-outline-secondary btn-remove';
            editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
            editBtn.title = 'Renommer';
            editBtn.onclick = () => editPreviewFileName(item, index, storageKey, previewContainer, uploadBtn, type);

            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-outline-danger btn-remove';
            removeBtn.innerHTML = '<i class="bi bi-x"></i>';
            removeBtn.title = 'Retirer';
            removeBtn.onclick = () => removePreviewFile(index, storageKey, previewContainer, uploadBtn, type);

            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(removeBtn);
            item.appendChild(actionsDiv);

            previewContainer.appendChild(item);
        });

        updateUploadButton(uploadBtn, filesToUpload[storageKey].length);
    }

    function editPreviewFileName(item, index, storageKey, previewContainer, uploadBtn, type) {
        const nameDiv = item.querySelector('.file-name');
        const currentName = filesToUpload[storageKey][index].customName;
        const ext = currentName.includes('.') ? '.' + currentName.split('.').pop() : '';
        const baseName = ext ? currentName.slice(0, -ext.length) : currentName;

        // Create input
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'file-name-input';
        input.value = baseName;

        nameDiv.innerHTML = '';
        nameDiv.appendChild(input);
        input.focus();
        input.select();

        const saveNewName = () => {
            const newBaseName = input.value.trim() || baseName;
            const newFullName = newBaseName + ext;
            filesToUpload[storageKey][index].customName = newFullName;
            nameDiv.textContent = newFullName;
            nameDiv.title = newFullName;
        };

        input.addEventListener('blur', saveNewName);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                input.blur();
            } else if (e.key === 'Escape') {
                nameDiv.textContent = currentName;
                nameDiv.title = currentName;
            }
        });
    }

    function removePreviewFile(index, storageKey, previewContainer, uploadBtn, type) {
        filesToUpload[storageKey].splice(index, 1);

        // Reset file input si no quedan archivos
        if (filesToUpload[storageKey].length === 0) {
            const inputId = type === 'photos' ? 'fileInputPhotos' : 'fileInputDocs';
            document.getElementById(inputId).value = '';
        }

        // Re-renderizar usando la funcion centralizada
        renderFilePreviewList(previewContainer, uploadBtn, type, storageKey);
    }

    function updateUploadButton(btn, count) {
        if (count > 0) {
            btn.disabled = false;
            btn.innerHTML = `<i class="bi bi-upload"></i> ${count} fichier${count > 1 ? 's' : ''}`;
        } else {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-upload"></i> Telecharger';
        }
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' o';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' Ko';
        return (bytes / (1024 * 1024)).toFixed(1) + ' Mo';
    }

    // ============================================
    // AJAX Form Submission para archivos
    // ============================================
    const uploadPhotosForm = document.getElementById('uploadPhotosForm');
    const uploadDocsForm = document.getElementById('uploadDocsForm');

    if (uploadPhotosForm) {
        uploadPhotosForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadFilesAjax('photos', 'photo', document.getElementById('uploadBtnPhotos'));
        });
    }

    if (uploadDocsForm) {
        uploadDocsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadFilesAjax('docs', 'fiche_technique', document.getElementById('uploadBtnDocs'));
        });
    }

    function uploadFilesAjax(storageKey, typeDocument, uploadBtn) {
        const files = filesToUpload[storageKey];
        if (files.length === 0) return;

        // Deshabilitar boton durante la subida
        const originalBtnText = uploadBtn.innerHTML;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Subiendo...';

        // Subir archivos uno por uno para mantener nombres personalizados
        let uploadPromises = files.map((fileObj, index) => {
            const formData = new FormData();
            formData.append('type_document', typeDocument);
            formData.append('fichier', fileObj.file);
            formData.append('nom_personnalise', fileObj.customName);

            return fetch(`/expeditions/${expeditionPk}/classification/upload/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            }).then(response => {
                if (!response.ok) {
                    return response.json().catch(() => ({ success: false, error: 'Error del servidor' }));
                }
                return response.json();
            });
        });

        Promise.all(uploadPromises)
            .then(results => {
                // Verificar si todos fueron exitosos
                const allSuccess = results.every(r => r.success);
                const successCount = results.filter(r => r.success).length;
                const errors = results.filter(r => !r.success).map(r => r.error);

                if (allSuccess && successCount > 0) {
                    // Limpiar el array y recargar la pagina
                    filesToUpload[storageKey] = [];
                    window.location.reload();
                } else if (successCount > 0) {
                    // Algunos fallaron pero algunos se subieron
                    console.error('Upload errors:', errors);
                    alert(`${successCount}/${files.length} archivos subidos. Errores: ${errors.join(', ')}`);
                    filesToUpload[storageKey] = [];
                    window.location.reload();
                } else {
                    // Todos fallaron
                    console.error('All uploads failed:', errors);
                    alert(`Error al subir archivos: ${errors[0] || 'Error desconocido'}`);
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = originalBtnText;
                }
            })
            .catch(error => {
                console.error('Error uploading files:', error);
                alert('Error de conexion al subir los archivos. Por favor, intente de nuevo.');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalBtnText;
            });
    }

    // ============================================
    // Document Management
    // ============================================
    const photosContainer = document.getElementById('photosContainer');
    const docsContainer = document.getElementById('docsContainer');

    if (photosContainer && !etapeTerminee) {
        new Sortable(photosContainer, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: () => saveOrder(photosContainer)
        });
    }

    if (docsContainer && !etapeTerminee) {
        new Sortable(docsContainer, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: () => saveOrder(docsContainer)
        });
    }

    function saveOrder(container) {
        const items = container.querySelectorAll('.document-item');
        const ordre = Array.from(items).map(item => parseInt(item.dataset.id));

        fetch(`/expeditions/${expeditionPk}/classification/documents/reordonner/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ ordre: ordre })
        });
    }

    // Delete documents
    let deleteDocId = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function() {
            deleteDocId = this.dataset.id;
            deleteModal.show();
        });
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
        if (!deleteDocId) return;

        const confirmBtn = this;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Suppression...';

        fetch(`/expeditions/${expeditionPk}/classification/document/${deleteDocId}/supprimer/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `Erreur ${response.status}`);
                }).catch(() => {
                    throw new Error(`Erreur ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const element = document.querySelector(`.document-item[data-id="${deleteDocId}"]`);
                if (element) {
                    element.remove();
                    // Mettre à jour le compteur
                    const container = element.closest('[data-type]');
                    if (container) {
                        const countEl = container.closest('.card-body').querySelector('.section-count');
                        if (countEl) {
                            const currentCount = parseInt(countEl.textContent) || 0;
                            countEl.textContent = Math.max(0, currentCount - 1);
                        }
                    }
                }
            } else {
                alert(data.error || 'Erreur lors de la suppression');
            }
            deleteModal.hide();
            deleteDocId = null;
        })
        .catch(error => {
            console.error('Erreur suppression:', error);
            alert('Erreur lors de la suppression: ' + error.message);
        })
        .finally(() => {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = 'Supprimer';
        });
    });

    // ============================================
    // Rename Documents
    // ============================================
    let renameDocId = null;
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    const newDocNameInput = document.getElementById('newDocName');

    document.querySelectorAll('.btn-rename').forEach(btn => {
        btn.addEventListener('click', function() {
            renameDocId = this.dataset.id;
            const currentName = this.dataset.name;
            // Remove extension for editing
            const ext = currentName.includes('.') ? '.' + currentName.split('.').pop() : '';
            const baseName = ext ? currentName.slice(0, -ext.length) : currentName;
            newDocNameInput.value = baseName;
            renameModal.show();
            setTimeout(() => newDocNameInput.select(), 100);
        });
    });

    document.getElementById('confirmRename').addEventListener('click', function() {
        if (!renameDocId) return;

        const newName = newDocNameInput.value.trim();
        if (!newName) {
            alert('Veuillez entrer un nom valide');
            return;
        }

        fetch(`/expeditions/${expeditionPk}/classification/document/${renameDocId}/renommer/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ nouveau_nom: newName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the name in the UI
                const element = document.querySelector(`.document-item[data-id="${renameDocId}"] .document-name`);
                if (element) {
                    element.textContent = data.nouveau_nom;
                    element.title = data.nouveau_nom;
                }
                // Update data-name attribute on button
                const btn = document.querySelector(`.btn-rename[data-id="${renameDocId}"]`);
                if (btn) {
                    btn.dataset.name = data.nouveau_nom;
                }
            } else {
                alert(data.error || 'Erreur lors du renommage');
            }
            renameModal.hide();
            renameDocId = null;
        });
    });

    // ============================================
    // Image Preview Modal
    // ============================================
    const imagePreviewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));

    document.querySelectorAll('.btn-preview-img').forEach(btn => {
        btn.addEventListener('click', function() {
            const url = this.dataset.url;
            const name = this.dataset.name;
            document.getElementById('imagePreviewImg').src = url;
            document.getElementById('imagePreviewTitle').textContent = name;
            imagePreviewModal.show();
        });
    });

    // ============================================
    // Chat Functions
    // ============================================
    function loadChatHistory() {
        fetch(`/expeditions/${expeditionPk}/classification/chat/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // IMPORTANT: Detacher proposalsSection avant de vider le chat
                    // car il est DANS chatMessages et serait supprime par innerHTML = ''
                    if (proposalsSection.parentNode) {
                        proposalsSection.parentNode.removeChild(proposalsSection);
                    }
                    chatMessages.innerHTML = '';

                    // Afficher les messages
                    data.messages.forEach(msg => {
                        appendMessage(msg);
                    });

                    // Reajouter proposalsSection A LA FIN (apres les messages)
                    chatMessages.appendChild(proposalsSection);

                    // Les proposals sont retournees separement par l'API (pas dans les messages)
                    // Afficher les proposals si elles existent au niveau racine
                    if (data.proposals && data.proposals.length > 0) {
                        console.log('[TARIC CHAT] Found', data.proposals.length, 'proposals from API');
                        latestProposals = data.proposals;
                        renderProposals(data.proposals);
                    }

                    // Verifier s'il y a une proposition selectionnee
                    if (data.has_selected_proposal && latestProposals.length > 0) {
                        const selected = latestProposals.find(p => p.is_selected);
                        if (selected) {
                            selectedProposalId = selected.id;
                            selectedProposalData = selected;
                            highlightSelectedProposal();
                        }
                    }

                    scrollToBottom();

                    // Si etape terminee, afficher le resume
                    if (data.etape_terminee) {
                        showCompletedSummary();
                    }

                    // Verifier le mode initial (analyze ou chat)
                    checkAndSetInitialMode(data.messages);
                }
            })
            .catch(error => {
                chatMessages.innerHTML = '<div class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle"></i> Erreur de chargement</div>';
            });
    }

    function appendMessage(msg) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.role}`;

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';

        // Parser le markdown pour les messages assistant
        if (msg.role === 'assistant' && typeof marked !== 'undefined') {
            bubbleDiv.innerHTML = marked.parse(msg.content);
        } else {
            bubbleDiv.textContent = msg.content;
        }

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = formatTime(msg.created_at);

        bubbleDiv.appendChild(timeDiv);

        // Ajouter la section tools_used pour les messages assistant
        if (msg.role === 'assistant') {
            const toolsUsed = msg.tools_used || (msg.metadata && msg.metadata.tools_used) || [];
            if (toolsUsed.length > 0) {
                const toolsSection = createToolsUsedSection(toolsUsed);
                bubbleDiv.appendChild(toolsSection);
            }
        }

        messageDiv.appendChild(bubbleDiv);
        chatMessages.appendChild(messageDiv);
    }

    function createToolsUsedSection(toolsUsed) {
        const section = document.createElement('div');
        section.className = 'tools-used';

        const header = document.createElement('div');
        header.className = 'tools-used-header';
        header.innerHTML = `<i class="bi bi-caret-down-fill"></i> <i class="bi bi-gear"></i> Outils utilises (${toolsUsed.length})`;

        const list = document.createElement('div');
        list.className = 'tools-used-list';

        // Mapeo de nombres de tools a iconos y etiquetas legibles
        const toolInfo = {
            'web_search': { icon: 'bi-search', label: 'Recherche web' },
            'browse_webpage': { icon: 'bi-globe', label: 'Navigation web' },
            'fetch_pdf': { icon: 'bi-file-pdf', label: 'Telecharger PDF' },
            'guardar_pdf_expediente': { icon: 'bi-save', label: 'Sauvegarder PDF' },
            'get_expedition_documents': { icon: 'bi-folder', label: 'Documents expedition' },
            'analyze_documents': { icon: 'bi-file-text', label: 'Analyser documents' }
        };

        toolsUsed.forEach(toolName => {
            const info = toolInfo[toolName] || { icon: 'bi-tools', label: toolName };
            const badge = document.createElement('span');
            badge.className = `tool-badge tool-${toolName}`;
            badge.innerHTML = `<i class="bi ${info.icon}"></i> ${info.label}`;
            list.appendChild(badge);
        });

        // Toggle visibility on header click
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            list.style.display = list.style.display === 'none' ? 'flex' : 'none';
        });

        section.appendChild(header);
        section.appendChild(list);

        return section;
    }

    function appendTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-bubble">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    function renderProposals(proposals) {
        proposalsContainer.innerHTML = '';
        proposalsSection.classList.remove('d-none');

        // Scroll to bottom after proposals are rendered
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);

        proposals.forEach((prop, index) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'proposal-btn';
            btn.dataset.id = prop.id || index;

            const probClass = prop.probability >= 70 ? 'high' :
                             prop.probability >= 40 ? 'medium' : 'low';

            // Format code TARIC avec points
            const formattedCode = prop.formatted_code || formatTaricCode(prop.code_taric);

            // Droits de douane et TVA
            const droits = prop.droits_douane || prop.droits || '-';
            const tva = prop.tva || '20%';
            const droitsClass = droits === '0%' ? 'tax-zero' : '';

            // Lien tarifdouanier.eu
            const lienTaric = prop.lien_taric || `https://www.tarifdouanier.eu/2026/${(prop.code_taric || '').slice(0, 8)}`;

            btn.innerHTML = `
                <div class="proposal-header">
                    <span class="code">${formattedCode}</span>
                    <span class="probability-badge ${probClass}">
                        <i class="bi bi-graph-up"></i> ${prop.probability}%
                    </span>
                </div>
                <div class="proposal-details">${prop.description || ''}</div>
                <div class="proposal-taxes">
                    <div class="proposal-tax">
                        <i class="bi bi-percent"></i>
                        <span class="tax-label">Droits:</span>
                        <span class="tax-value ${droitsClass}">${droits}</span>
                    </div>
                    <div class="proposal-tax">
                        <i class="bi bi-receipt"></i>
                        <span class="tax-label">TVA:</span>
                        <span class="tax-value">${tva}</span>
                    </div>
                    <div class="proposal-tax">
                        <a href="${lienTaric}" target="_blank" class="btn btn-sm btn-outline-info" onclick="event.stopPropagation();">
                            <i class="bi bi-box-arrow-up-right"></i> Plus d'infos
                        </a>
                    </div>
                </div>
            `;

            btn.addEventListener('click', () => selectProposal(prop, index));
            proposalsContainer.appendChild(btn);
        });
    }

    function formatTaricCode(code) {
        if (!code || code.length !== 10) return code || '';
        return `${code.slice(0,4)}.${code.slice(4,6)}.${code.slice(6,8)}.${code.slice(8,10)}`;
    }

    function selectProposal(proposal, index) {
        if (etapeTerminee) return;

        selectedProposalId = proposal.id || index;
        selectedProposalData = proposal;

        // Highlight immediatement
        highlightSelectedProposal();

        // Remplir le modal avec les details
        const formattedCode = proposal.formatted_code || formatTaricCode(proposal.code_taric);
        const lienTaric = proposal.lien_taric || `https://www.tarifdouanier.eu/2026/${(proposal.code_taric || '').slice(0, 8)}`;

        document.getElementById('modalCode').textContent = formattedCode;
        document.getElementById('modalDescription').textContent = proposal.description || '';
        document.getElementById('modalDroits').textContent = proposal.droits_douane || proposal.droits || '-';
        document.getElementById('modalTVA').textContent = proposal.tva || '20%';
        document.getElementById('modalProbability').textContent = `Precision: ${proposal.probability}%`;

        // Mettre a jour le lien tarifdouanier.eu dans le modal
        const modalLink = document.getElementById('modalTaricLink');
        if (modalLink) {
            modalLink.href = lienTaric;
        }

        // Couleur selon probabilite
        const probBadge = document.getElementById('modalProbability');
        probBadge.className = 'badge fs-6';
        if (proposal.probability >= 70) {
            probBadge.classList.add('bg-success');
        } else if (proposal.probability >= 40) {
            probBadge.classList.add('bg-warning', 'text-dark');
        } else {
            probBadge.classList.add('bg-danger');
        }

        // Afficher le modal directement
        validateModal.show();
    }

    function highlightSelectedProposal() {
        document.querySelectorAll('.proposal-btn').forEach(btn => {
            btn.classList.remove('selected');
            if (parseInt(btn.dataset.id) === selectedProposalId) {
                btn.classList.add('selected');
            }
        });
    }

    // Validation
    const validateModal = new bootstrap.Modal(document.getElementById('validateModal'));

    // Le bouton validateBtn n'est plus necessaire car on ouvre le modal directement au clic sur une proposition

    document.getElementById('confirmValidate').addEventListener('click', function() {
        if (!selectedProposalData) return;

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Validation en cours...';

        // Envoyer les donnees de la proposition selectionnee
        fetch(`/expeditions/${expeditionPk}/classification/chat/validate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                proposal_index: selectedProposalId,
                proposal_data: selectedProposalData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fermer le modal
                validateModal.hide();

                // Afficher message de succes
                const successHtml = `
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-success mb-3">Classification validee!</h4>
                        <p class="text-muted mb-4">
                            Code TARIC: <strong class="text-primary fs-5">${formatTaricCode(data.result.code_taric)}</strong>
                        </p>
                        <p class="mb-4">Redirection vers l'etape suivante...</p>
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                `;

                // Remplacer le contenu du chat par le message de succes
                chatMessages.innerHTML = successHtml;
                proposalsSection.classList.add('d-none');

                // Rediriger vers l'etape 2 (Documents) apres 2 secondes
                setTimeout(() => {
                    window.location.href = `/expeditions/${expeditionPk}/documents/`;
                }, 2000);

            } else {
                alert(data.error || 'Erreur lors de la validation');
                document.getElementById('confirmValidate').disabled = false;
                document.getElementById('confirmValidate').innerHTML = '<i class="bi bi-check-lg"></i> Oui, valider cette classification';
            }
        })
        .catch(error => {
            console.error('Validation error:', error);
            alert('Erreur de connexion. Veuillez reessayer.');
            document.getElementById('confirmValidate').disabled = false;
            document.getElementById('confirmValidate').innerHTML = '<i class="bi bi-check-lg"></i> Oui, valider cette classification';
        });
    });

    function showSummary(result, summary) {
        summarySection.classList.remove('d-none');
        document.getElementById('summaryCode').textContent = result.code_taric;

        let html = `
            <p><strong>Description:</strong> ${result.description || 'N/A'}</p>
            <p><strong>Precision:</strong> ${result.probability}%</p>
            <p><strong>Justification:</strong> ${result.justification || 'N/A'}</p>
        `;

        if (summary && summary.key_points) {
            html += '<hr><p><strong>Points cles:</strong></p><ul>';
            summary.key_points.forEach(point => {
                html += `<li>${point}</li>`;
            });
            html += '</ul>';
        }

        document.getElementById('summaryContent').innerHTML = html;
    }

    function showCompletedSummary() {
        // Charger les donnees de l'etape pour afficher le resume
        // Pour l'instant, juste afficher le message que c'est termine
        proposalsSection.classList.add('d-none');
    }

    // ============================================
    // Analyze Button (mode initial)
    // ============================================
    function switchToChatMode() {
        if (analyzeMode) analyzeMode.classList.add('d-none');
        if (chatForm) {
            chatForm.classList.remove('d-none');
            chatForm.classList.add('d-flex');
        }
    }

    function switchToAnalyzeMode() {
        // Forzar modo analisis
        if (analyzeMode) {
            analyzeMode.classList.remove('d-none');
        }
        if (chatForm) {
            chatForm.classList.add('d-none');
            chatForm.classList.remove('d-flex');
        }
    }

    function checkAndSetInitialMode(messages) {
        // Rester en mode analyse SAUF si l'utilisateur a deja envoye un message
        // Le message de bienvenue (assistant) ne compte pas
        console.log('[DEBUG] checkAndSetInitialMode called with', messages ? messages.length : 0, 'messages');
        if (messages && messages.length > 0) {
            const hasUserMessage = messages.some(msg => msg.role === 'user');
            console.log('[DEBUG] hasUserMessage:', hasUserMessage);
            if (hasUserMessage) {
                console.log('[DEBUG] Switching to chat mode');
                switchToChatMode();
            } else {
                console.log('[DEBUG] Forcing analyze mode (only welcome message)');
                switchToAnalyzeMode();
            }
        } else {
            console.log('[DEBUG] No messages, forcing analyze mode');
            switchToAnalyzeMode();
        }
    }

    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function() {
            const context = analyzeContext ? analyzeContext.value.trim() : '';

            // Desactivar boton
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyse en cours...';

            // Mostrar mensaje del usuario
            const userMessage = context ? `Analyser les documents: ${context}` : 'Analyser les documents';
            appendMessage({
                role: 'user',
                content: userMessage,
                created_at: new Date().toISOString()
            });

            appendTypingIndicator();
            scrollToBottom();

            // Llamar al endpoint de analisis
            fetch(`/expeditions/${expeditionPk}/classification/chat/analyze/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ context: context })
            })
            .then(response => response.json())
            .then(data => {
                removeTypingIndicator();

                if (data.success) {
                    // Cambiar a modo chat
                    switchToChatMode();

                    // Mostrar respuesta
                    appendMessage(data.assistant_message);

                    // Debug: log proposals
                    console.log('[TARIC CHAT] Assistant message:', data.assistant_message);
                    console.log('[TARIC CHAT] Proposals in response:', data.assistant_message.proposals);

                    // Si hay proposals, mostrarlas
                    if (data.assistant_message.proposals && data.assistant_message.proposals.length > 0) {
                        console.log('[TARIC CHAT] Rendering', data.assistant_message.proposals.length, 'proposals');
                        latestProposals = data.assistant_message.proposals;
                        renderProposals(data.assistant_message.proposals);
                    } else {
                        console.log('[TARIC CHAT] No proposals found in assistant_message');
                    }

                    // Recargar documentos web
                    refreshWebDocuments();

                    scrollToBottom();
                } else {
                    // Reactivar boton en caso de error
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="bi bi-cpu"></i> Analyser les documents';

                    appendMessage({
                        role: 'assistant',
                        content: data.error || 'Erreur lors de l\'analyse',
                        created_at: new Date().toISOString()
                    });
                }
            })
            .catch(error => {
                console.error('Analyze error:', error);
                removeTypingIndicator();
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="bi bi-cpu"></i> Analyser les documents';

                appendMessage({
                    role: 'assistant',
                    content: `Erreur: ${error.message || 'Connexion echouee'}. Veuillez reessayer.`,
                    created_at: new Date().toISOString()
                });
            });
        });
    }

    // ============================================
    // Chat form submission (mode normal)
    // ============================================
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const message = chatInput.value.trim();
            if (!message) return;

            // Ajouter le message utilisateur
            appendMessage({
                role: 'user',
                content: message,
                created_at: new Date().toISOString()
            });

            chatInput.value = '';
            sendBtn.disabled = true;
            appendTypingIndicator();
            scrollToBottom();

            // Envoyer au serveur
            fetch(`/expeditions/${expeditionPk}/classification/chat/message/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                removeTypingIndicator();
                sendBtn.disabled = false;

                if (data.success) {
                    appendMessage(data.assistant_message);

                    // Si des proposals, les afficher
                    if (data.assistant_message.proposals && data.assistant_message.proposals.length > 0) {
                        latestProposals = data.assistant_message.proposals;
                        renderProposals(data.assistant_message.proposals);
                    }

                    // Recargar documentos web (puede que el agente haya guardado alguno)
                    refreshWebDocuments();

                    scrollToBottom();
                } else {
                    appendMessage({
                        role: 'assistant',
                        content: data.error || 'Erreur lors du traitement',
                        created_at: new Date().toISOString()
                    });
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                removeTypingIndicator();
                sendBtn.disabled = false;
                appendMessage({
                    role: 'assistant',
                    content: `Erreur: ${error.message || 'Connexion echouee'}. Veuillez reessayer.`,
                    created_at: new Date().toISOString()
                });
            });
        });
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    // ============================================
    // Web Documents (documentos descargados por IA)
    // ============================================
    function refreshWebDocuments() {
        fetch(`/expeditions/${expeditionPk}/classification/web-documents/`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('webDocumentsContainer');
                const countBadge = document.getElementById('webDocsCount');

                if (countBadge) {
                    countBadge.textContent = data.count;
                }

                if (data.count === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-3" id="webDocsEmpty">
                            <i class="bi bi-inbox fs-3"></i>
                            <p class="mb-0 small">L'assistant n'a pas encore trouvé de documents pertinents.</p>
                            <p class="mb-0 small text-info">Les documents utiles apparaîtront ici.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.documents.map(doc => `
                        <div class="web-document-item mb-2 p-2 border rounded bg-light" data-id="${doc.id}">
                            <div class="d-flex align-items-start">
                                <div class="me-2 text-info">
                                    <i class="bi bi-file-earmark-pdf-fill fs-4"></i>
                                </div>
                                <div class="flex-grow-1 min-width-0">
                                    <div class="fw-bold text-truncate" title="${doc.titulo}">${doc.titulo}</div>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-link-45deg"></i> ${doc.dominio}
                                        <span class="mx-1">|</span>
                                        <i class="bi bi-file-earmark"></i> ${doc.tamano}
                                        ${doc.paginas ? `<span class="mx-1">|</span> ${doc.paginas} pages` : ''}
                                    </small>
                                    ${doc.razon ? `
                                    <small class="text-success d-block mt-1">
                                        <i class="bi bi-check-circle"></i> ${doc.razon.split(' ').slice(0, 15).join(' ')}${doc.razon.split(' ').length > 15 ? '...' : ''}
                                    </small>
                                    ` : ''}
                                </div>
                                <div class="ms-2">
                                    <a href="${doc.fichier_url}" target="_blank" class="btn btn-info btn-sm" title="Voir le PDF">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="${doc.fichier_url}" download class="btn btn-outline-info btn-sm" title="Télécharger">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        })
        .catch(error => {
            console.error('Error refreshing web documents:', error);
        });
    }

    // Charger l'historique au demarrage
    loadChatHistory();
});
</script>
{% endblock %}
