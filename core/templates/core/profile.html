{% extends 'core/base.html' %}

{% block title %}Mi Perfil - BasePage{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4">Mi Perfil</h2>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Nombre de usuario:</strong>
                        </div>
                        <div class="col-md-8">
                            {{ user.username }}
                        </div>
                    </div>

                    {% if user.first_name or user.last_name %}
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Nombre completo:</strong>
                        </div>
                        <div class="col-md-8">
                            {{ user.first_name }} {{ user.last_name }}
                        </div>
                    </div>
                    {% endif %}

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Correo electrónico:</strong>
                        </div>
                        <div class="col-md-8">
                            {{ user.email }}
                            {% if EMAIL_VERIFICATION_REQUIRED %}
                                {% if user.email_verified %}
                                    <span class="badge bg-success ms-2">
                                        <i class="bi bi-check-circle"></i> Confirmado
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning ms-2">
                                        <i class="bi bi-exclamation-circle"></i> Sin confirmar
                                    </span>
                                    <a href="{% url 'authentication:resend_verification' %}" class="btn btn-sm btn-link">
                                        Reenviar confirmación
                                    </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Teléfono:</strong>
                        </div>
                        <div class="col-md-8">
                            {% if user.phone %}
                                {{ user.phone }}
                            {% else %}
                                <span class="text-muted">No especificado</span>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="card mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        <div class="card-body text-white">
                            <h5 class="mb-3 text-white">
                                <i class="bi bi-robot"></i> Configuración de IA
                            </h5>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <strong class="text-white">Proveedor:</strong>
                                </div>
                                <div class="col-md-8">
                                    {% if user.llm_provider == 'gemini' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-google"></i> Google Gemini
                                        </span>
                                    {% elif user.llm_provider == 'openai' %}
                                        <span class="badge bg-primary">
                                            <i class="bi bi-lightning-fill"></i> OpenAI
                                        </span>
                                    {% elif user.llm_provider == 'nvidia' %}
                                        <span class="badge bg-dark">
                                            <i class="bi bi-gpu-card"></i> NVIDIA NIM
                                        </span>
                                    {% elif user.llm_provider == 'ollama' %}
                                        <span class="badge bg-light text-dark">
                                            <i class="bi bi-laptop"></i> Ollama (Local)
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">No configurado</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if user.llm_provider == 'ollama' %}
                                <!-- Configuración de Ollama -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <strong class="text-white">Modelo de Chat:</strong>
                                    </div>
                                    <div class="col-md-8">
                                        <code class="bg-light text-dark p-2 rounded d-inline-block">
                                            {{ user.ollama_model|default:"qwen2.5:72b" }}
                                        </code>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <strong class="text-white">Modelo de Embeddings:</strong>
                                    </div>
                                    <div class="col-md-8">
                                        <code class="bg-light text-dark p-2 rounded d-inline-block">
                                            {{ user.ollama_embedding_model|default:"nomic-embed-text" }}
                                        </code>
                                    </div>
                                </div>

                                <div class="alert alert-light mt-3 mb-0">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <i class="bi bi-info-circle"></i>
                                            <strong>IA Local</strong> - Sin costes, 100% privado
                                        </div>
                                        <a href="{% url 'core:ollama_check' %}" class="btn btn-sm btn-primary">
                                            <i class="bi bi-check-circle"></i> Verificar Configuración
                                        </a>
                                    </div>
                                </div>
                            {% elif user.llm_provider == 'openai' %}
                                <!-- Configuración de OpenAI -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <strong class="text-white">Modelo Seleccionado:</strong>
                                    </div>
                                    <div class="col-md-8">
                                        {% with model=user.openai_model|default:"gpt-4o-mini" %}
                                            <code class="bg-light text-dark p-2 rounded d-inline-block">
                                                {{ model }}
                                            </code>
                                            {% if model == 'gpt-4o-mini' %}
                                                <span class="badge bg-success ms-2">Recomendado</span>
                                                <small class="text-white-50 d-block mt-1">
                                                    <i class="bi bi-info-circle"></i> Balance perfecto calidad/precio (~€0.0006/conversación)
                                                </small>
                                            {% elif model == 'gpt-4o' %}
                                                <span class="badge bg-warning text-dark ms-2">Premium</span>
                                                <small class="text-white-50 d-block mt-1">
                                                    <i class="bi bi-info-circle"></i> Más potente (~€0.0024/conversación - 4x más caro)
                                                </small>
                                            {% elif model == 'gpt-4-turbo' %}
                                                <span class="badge bg-secondary ms-2">Anterior Gen</span>
                                                <small class="text-white-50 d-block mt-1">
                                                    <i class="bi bi-info-circle"></i> Generación anterior
                                                </small>
                                            {% elif model == 'gpt-3.5-turbo' %}
                                                <span class="badge bg-info ms-2">Económico</span>
                                                <small class="text-white-50 d-block mt-1">
                                                    <i class="bi bi-info-circle"></i> Más económico (~€0.0003/conversación) pero menos capaz
                                                </small>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            {% endif %}

                            {% if user.llm_provider != 'ollama' %}
                                <!-- Configuración de proveedores cloud -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <strong class="text-white">API Key:</strong>
                                    </div>
                                    <div class="col-md-8">
                                        {% if user.llm_api_key %}
                                            <div class="d-flex align-items-center">
                                                <code class="bg-light text-dark p-2 rounded flex-grow-1" style="font-size: 12px; overflow: hidden; text-overflow: ellipsis;">
                                                    {{ user.llm_api_key|slice:":20" }}••••••••••••••••
                                                </code>
                                                <span class="badge bg-light text-success ms-2">
                                                    <i class="bi bi-check-circle"></i> Configurada
                                                </span>
                                            </div>
                                            <small class="text-white-50 d-block mt-1">
                                                <i class="bi bi-info-circle"></i> Lista para Chat IA y Vectorización
                                            </small>
                                        {% else %}
                                            <div class="alert alert-warning mb-0">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <strong>No configurada</strong>
                                                <p class="mb-2 mt-2">Para usar el <strong>Chat IA</strong> y la <strong>Vectorización</strong>, necesitas configurar una API key.</p>
                                                <div class="d-flex gap-2">
                                                    {% if user.llm_provider == 'gemini' %}
                                                        <a href="https://aistudio.google.com/apikey" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-box-arrow-up-right"></i> Obtener API Key
                                                        </a>
                                                    {% elif user.llm_provider == 'openai' %}
                                                        <a href="https://platform.openai.com/api-keys" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-box-arrow-up-right"></i> Obtener API Key
                                                        </a>
                                                    {% elif user.llm_provider == 'nvidia' %}
                                                        <a href="https://build.nvidia.com/settings/api-keys" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-box-arrow-up-right"></i> Obtener API Key
                                                        </a>
                                                    {% endif %}
                                                    <a href="{% url 'core:edit_profile' %}" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-gear"></i> Configurar Ahora
                                                    </a>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Web Search Configuration -->
                    <div class="card mb-3 border-info">
                        <div class="card-body">
                            <h5 class="mb-3">
                                <i class="bi bi-globe"></i> Configuración de Búsqueda Web
                            </h5>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <strong>Estado:</strong>
                                </div>
                                <div class="col-md-8">
                                    {% if user.use_web_search %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Activada
                                        </span>
                                        {% if user.google_search_api_key and user.google_search_engine_id %}
                                            <span class="badge bg-light text-success ms-2">
                                                <i class="bi bi-key-fill"></i> Credenciales configuradas
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark ms-2">
                                                <i class="bi bi-exclamation-triangle"></i> Faltan credenciales
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle"></i> Desactivada
                                        </span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if user.use_web_search %}
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <strong>Google Search API Key:</strong>
                                    </div>
                                    <div class="col-md-8">
                                        {% if user.google_search_api_key %}
                                            <code class="bg-light text-dark p-2 rounded d-inline-block" style="font-size: 12px;">
                                                {{ user.google_search_api_key|slice:":20" }}••••••••••••••••
                                            </code>
                                        {% else %}
                                            <span class="text-muted">No configurada</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <strong>Search Engine ID:</strong>
                                    </div>
                                    <div class="col-md-8">
                                        {% if user.google_search_engine_id %}
                                            <code class="bg-light text-dark p-2 rounded d-inline-block">
                                                {{ user.google_search_engine_id }}
                                            </code>
                                        {% else %}
                                            <span class="text-muted">No configurado</span>
                                        {% endif %}
                                    </div>
                                </div>

                                {% if not user.google_search_api_key or not user.google_search_engine_id %}
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <strong>Configuración incompleta</strong>
                                        <p class="mb-2 mt-2">Para que el agente pueda buscar en internet, necesitas configurar ambas credenciales de Google Search API.</p>
                                        <a href="{% url 'core:edit_profile' %}" class="btn btn-sm btn-primary">
                                            <i class="bi bi-gear"></i> Configurar Credenciales
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="alert alert-success mb-0">
                                        <i class="bi bi-check-circle"></i>
                                        <strong>Todo listo</strong> - El agente puede buscar información actualizada en internet cuando lo necesite.
                                        <small class="d-block mt-1">
                                            <i class="bi bi-info-circle"></i> Cuota gratuita: 100 búsquedas/día
                                        </small>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle"></i>
                                    La búsqueda web está desactivada. El agente solo utilizará información de tu base de datos de licitaciones.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-3">

                    <h5 class="mb-3">Dirección de Envío</h5>

                    {% if user.has_complete_address %}
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Dirección completa:</strong>
                        </div>
                        <div class="col-md-8">
                            {% if user.address_line1 %}
                                {{ user.address_line1 }}<br>
                            {% endif %}
                            {% if user.address_line2 %}
                                {{ user.address_line2 }}<br>
                            {% endif %}
                            {% if user.city or user.state_province or user.postal_code %}
                                {{ user.city }}{% if user.city and user.state_province %}, {% endif %}{{ user.state_province }} {{ user.postal_code }}<br>
                            {% endif %}
                            {% if user.country %}
                                {{ user.country }}
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning alert-permanent">
                        <i class="bi bi-exclamation-triangle"></i>
                        No tienes una dirección de envío completa.
                        <a href="{% url 'core:edit_profile' %}">Añádela ahora</a>
                    </div>
                    {% endif %}

                    <hr class="my-3">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Fecha de registro:</strong>
                        </div>
                        <div class="col-md-8">
                            {{ user.created_at|date:"d/m/Y H:i" }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Último acceso:</strong>
                        </div>
                        <div class="col-md-8">
                            {{ user.last_login|date:"d/m/Y H:i"|default:"Nunca" }}
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="text-center">
                        <a href="{% url 'core:edit_profile' %}" class="btn btn-primary me-2">
                            <i class="bi bi-pencil"></i> Editar Perfil
                        </a>
                        <a href="{% url 'authentication:password_reset_request' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-key"></i> Cambiar Contraseña
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}