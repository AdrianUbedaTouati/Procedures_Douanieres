{% extends 'core/base.html' %}

{% block title %}Dashboard - TenderAI{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Dashboard</h1>

            {% if not has_company_profile %}
            <div class="alert alert-warning" role="alert">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Perfil de Empresa Incompleto</h5>
                <p>Para obtener recomendaciones personalizadas, completa tu perfil de empresa.</p>
                <a href="{% url 'company:profile' %}" class="btn btn-warning">Completar Perfil</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Licitaciones</h5>
                    <h2 class="display-4 text-primary">{{ total_tenders }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Licitaciones Guardadas</h5>
                    <h2 class="display-4 text-success">{{ saved_tenders_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Recomendaciones</h5>
                    <h2 class="display-4 text-warning">{{ recommended_tenders|length }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Guardadas por estado -->
    {% if saved_by_status %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Mis Licitaciones por Estado</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Interesado</p>
                            <h4>{{ saved_by_status.interested|default:0 }}</h4>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Oferta Presentada</p>
                            <h4>{{ saved_by_status.applied|default:0 }}</h4>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Ganadas</p>
                            <h4 class="text-success">{{ saved_by_status.won|default:0 }}</h4>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Perdidas</p>
                            <h4 class="text-danger">{{ saved_by_status.lost|default:0 }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Licitaciones Recomendadas -->
    {% if has_company_profile and recommended_tenders %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-star-fill text-warning"></i> Top Recomendaciones</h5>
                    <a href="{% url 'tenders:recommended' %}" class="btn btn-sm btn-primary">Ver Todas</a>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for recommendation in recommended_tenders %}
                        <a href="{% url 'tenders:detail' recommendation.tender.ojs_notice_id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ recommendation.tender.title|truncatechars:80 }}</h6>
                                <span class="badge
                                    {% if recommendation.recommendation_level == 'alta' %}bg-success
                                    {% elif recommendation.recommendation_level == 'media' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    {{ recommendation.get_recommendation_level_display }}
                                </span>
                            </div>
                            <p class="mb-1 text-muted small">{{ recommendation.tender.buyer_name }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Score: {{ recommendation.score_total|floatformat:1 }}/100 |
                                    Probabilidad: {{ recommendation.probability_success|floatformat:1 }}%
                                </small>
                                {% if recommendation.tender.budget_amount %}
                                <small class="text-primary">{{ recommendation.tender.budget_amount|floatformat:0 }} {{ recommendation.tender.currency }}</small>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Licitaciones Recientes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Licitaciones Recientes</h5>
                    <a href="{% url 'tenders:list' %}" class="btn btn-sm btn-primary">Buscar Más</a>
                </div>
                <div class="card-body">
                    {% if recent_tenders %}
                    <div class="list-group">
                        {% for tender in recent_tenders %}
                        <a href="{% url 'tenders:detail' tender.ojs_notice_id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ tender.title|truncatechars:80 }}</h6>
                                <small class="text-muted">{{ tender.publication_date|date:"d/m/Y" }}</small>
                            </div>
                            <p class="mb-1 text-muted small">{{ tender.buyer_name }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small>
                                    <span class="badge bg-info">{{ tender.get_contract_type_display }}</span>
                                    {% if tender.deadline %}
                                    <span class="text-danger"><i class="bi bi-alarm"></i> Vence: {{ tender.deadline|date:"d/m/Y" }}</span>
                                    {% endif %}
                                </small>
                                {% if tender.budget_amount %}
                                <small class="text-primary fw-bold">{{ tender.budget_amount|floatformat:0 }} {{ tender.currency }}</small>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No hay licitaciones disponibles en este momento.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Botón de Acciones Rápidas -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'chat:session_create' %}" class="btn btn-lg btn-success" onclick="event.preventDefault(); fetch('{% url 'chat:session_create' %}', {method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}}).then(r => r.json()).then(d => window.location.href = d.redirect_url);">
                <i class="bi bi-chat-dots"></i> Consultar con el Agente IA
            </a>
        </div>
    </div>
</div>
{% endblock %}
