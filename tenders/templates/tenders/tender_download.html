{% extends 'core/base.html' %}

{% block title %}Obtener Licitaciones - TenderAI{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 40px; margin-top: 40px;">
                <h1 style="font-size: 48px; font-weight: 700; color: #1d1d1f; margin-bottom: 16px;">
                    Obtener Licitaciones
                </h1>
                <p style="font-size: 18px; color: #6e6e73; max-width: 600px; margin: 0 auto;">
                    Descarga licitaciones directamente desde la API de TED (Tenders Electronic Daily) de la Uni√≥n Europea.
                </p>
            </div>

            <!-- Card principal -->
            <div style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 40px; margin-bottom: 24px;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 64px; margin-bottom: 16px;">üöÄ</div>
                    <h2 style="font-size: 28px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px;">
                        Configurar Descarga
                    </h2>
                    <p style="color: #6e6e73; font-size: 16px;">
                        Actualmente tienes <strong style="color: #1d1d1f;">{{ total_tenders }} licitaciones</strong> en tu base de datos
                    </p>
                    {% if total_tenders > 0 %}
                    <div style="margin-top: 16px;">
                        <button
                            id="deleteAllBtn"
                            type="button"
                            onclick="confirmDeleteAll()"
                            style="padding: 10px 24px; background: #ff3b30; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            <i class="bi bi-trash3"></i> Borrar Todos los XMLs
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Formulario de descarga -->
                <form id="downloadForm">
                    <!-- Par√°metros B√°sicos -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #1d1d1f; margin-bottom: 16px; border-bottom: 2px solid #f5f5f7; padding-bottom: 8px;">
                            ‚è±Ô∏è Par√°metros de Tiempo y Cantidad
                        </h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="days_back" style="display: block; margin-bottom: 10px; font-weight: 600; color: #1d1d1f; font-size: 15px;">
                                    <i class="bi bi-calendar-range"></i> Per√≠odo (d√≠as hacia atr√°s)
                                </label>
                                <input
                                    type="number"
                                    name="days_back"
                                    id="days_back"
                                    value="30"
                                    min="1"
                                    max="365"
                                    required
                                    style="width: 100%; padding: 14px; border: 2px solid #d2d2d7; border-radius: 10px; font-size: 16px;">
                                <small style="color: #6e6e73; display: block; margin-top: 8px; font-size: 13px;">
                                    Recomendado: 30 d√≠as
                                </small>
                            </div>

                            <div>
                                <label for="max_download" style="display: block; margin-bottom: 10px; font-weight: 600; color: #1d1d1f; font-size: 15px;">
                                    <i class="bi bi-download"></i> M√°ximo a descargar
                                </label>
                                <input
                                    type="number"
                                    name="max_download"
                                    id="max_download"
                                    value="50"
                                    min="10"
                                    max="200"
                                    required
                                    style="width: 100%; padding: 14px; border: 2px solid #d2d2d7; border-radius: 10px; font-size: 16px;">
                                <small style="color: #6e6e73; display: block; margin-top: 8px; font-size: 13px;">
                                    Recomendado: 50
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros de B√∫squeda TED API -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #1d1d1f; margin-bottom: 16px; border-bottom: 2px solid #f5f5f7; padding-bottom: 8px;">
                            üîç Filtros de B√∫squeda en TED
                        </h3>

                        <!-- C√≥digos CPV con Autocompletado -->
                        <div style="margin-bottom: 20px;">
                            <label for="cpv_input_download" style="display: block; margin-bottom: 10px; font-weight: 600; color: #1d1d1f; font-size: 15px;">
                                <i class="bi bi-tag"></i> C√≥digos CPV
                            </label>
                            <div class="tags-container" id="cpvContainerDownload">
                                <input
                                    type="text"
                                    class="tag-input"
                                    id="cpv_input_download"
                                    placeholder="Buscar por c√≥digo o nombre..."
                                    autocomplete="off"
                                >
                                <div class="autocomplete-dropdown" id="cpvDropdownDownload"></div>
                            </div>
                            <input type="hidden" name="cpv_codes" id="cpv_codes_hidden">
                            <small style="color: #6e6e73; display: block; margin-top: 8px; font-size: 13px;">
                                <i class="bi bi-info-circle"></i> Busca y selecciona c√≥digos CPV (software, consultor√≠a, etc.)
                            </small>
                        </div>

                        <!-- Pa√≠s/Regi√≥n -->
                        <div style="margin-bottom: 20px;">
                            <label for="place" style="display: block; margin-bottom: 10px; font-weight: 600; color: #1d1d1f; font-size: 15px;">
                                <i class="bi bi-geo-alt"></i> Pa√≠s/Regi√≥n
                            </label>
                            <select
                                name="place"
                                id="place"
                                style="width: 100%; padding: 14px; border: 2px solid #d2d2d7; border-radius: 10px; font-size: 16px;">
                                <option value="ESP">Espa√±a (ESP)</option>
                                <option value="FRA">Francia (FRA)</option>
                                <option value="DEU">Alemania (DEU)</option>
                                <option value="ITA">Italia (ITA)</option>
                                <option value="PRT">Portugal (PRT)</option>
                                <option value="">Todos los pa√≠ses</option>
                            </select>
                            <small style="color: #6e6e73; display: block; margin-top: 8px; font-size: 13px;">
                                Selecciona el pa√≠s donde se ejecutar√° el contrato
                            </small>
                        </div>

                        <!-- Tipo de Aviso -->
                        <div style="margin-bottom: 20px;">
                            <label for="notice_type" style="display: block; margin-bottom: 10px; font-weight: 600; color: #1d1d1f; font-size: 15px;">
                                <i class="bi bi-file-earmark-text"></i> Tipo de Aviso
                            </label>
                            <select
                                name="notice_type"
                                id="notice_type"
                                style="width: 100%; padding: 14px; border: 2px solid #d2d2d7; border-radius: 10px; font-size: 16px;">
                                <option value="cn-standard">Aviso de contrato (cn-standard)</option>
                                <option value="pin-only">Informaci√≥n previa (pin-only)</option>
                                <option value="can-standard">Aviso de adjudicaci√≥n (can-standard)</option>
                                <option value="">Todos los tipos</option>
                            </select>
                            <small style="color: #6e6e73; display: block; margin-top: 8px; font-size: 13px;">
                                "Aviso de contrato" es el m√°s com√∫n para buscar oportunidades
                            </small>
                        </div>
                    </div>

                    <!-- Advertencia -->
                    <div style="margin-bottom: 24px; padding: 16px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <div style="display: flex; align-items: start;">
                            <i class="bi bi-clock-history" style="font-size: 20px; color: #856404; margin-right: 12px; margin-top: 2px;"></i>
                            <div>
                                <strong style="color: #856404; font-size: 14px;">Tiempo de procesamiento</strong>
                                <p style="margin: 4px 0 0 0; color: #856404; font-size: 13px;">
                                    Este proceso puede tardar varios minutos. Ver√°s el progreso en tiempo real.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√≥n de descarga -->
                    <button
                        type="submit"
                        style="width: 100%; padding: 16px; background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);">
                        <i class="bi bi-rocket-takeoff"></i> Iniciar Descarga
                    </button>
                </form>
            </div>

            <!-- Panel de progreso (oculto inicialmente) -->
            <div id="progressPanel" style="display: none; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 40px; margin-bottom: 24px;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 64px; margin-bottom: 16px;" id="progressEmoji">‚è≥</div>
                    <h2 style="font-size: 28px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px;" id="progressTitle">
                        Descargando...
                    </h2>
                </div>

                <!-- Barra de progreso -->
                <div style="margin-bottom: 32px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #1d1d1f;" id="progressText">Iniciando...</span>
                        <span style="font-weight: 600; color: #007aff;" id="progressPercentage">0%</span>
                    </div>
                    <div style="width: 100%; height: 24px; background: #f5f5f7; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="progressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #007aff 0%, #00c7ff 100%); border-radius: 12px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;">
                            <span style="color: white; font-size: 12px; font-weight: 600;" id="progressCount"></span>
                        </div>
                    </div>
                </div>

                <!-- Log de actividad -->
                <div style="background: #1d1d1f; border-radius: 12px; padding: 24px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; color: #00ff00;" id="logContainer">
                    <div id="logContent"></div>
                </div>

                <!-- Bot√≥n para ir a buscar (oculto hasta completar) -->
                <div id="completeActions" style="display: none; margin-top: 24px; text-align: center;">
                    <a href="{% url 'tenders:list' %}" style="display: inline-block; padding: 14px 32px; background: #34c759; color: white; text-decoration: none; border-radius: 10px; font-weight: 600; transition: all 0.2s;">
                        <i class="bi bi-search"></i> Ir a Buscar Licitaciones
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('downloadForm');
    const progressPanel = document.getElementById('progressPanel');
    const logContent = document.getElementById('logContent');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressCount = document.getElementById('progressCount');
    const progressTitle = document.getElementById('progressTitle');
    const progressEmoji = document.getElementById('progressEmoji');
    const completeActions = document.getElementById('completeActions');

    let totalToDownload = 0;
    let currentDownload = 0;

    function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        let color = '#00ff00';
        let icon = '‚Ä¢';

        switch(type) {
            case 'success': color = '#34c759'; icon = '‚úì'; break;
            case 'error': color = '#ff3b30'; icon = '‚úó'; break;
            case 'warning': color = '#ffcc00'; icon = '‚ö†'; break;
            case 'info': color = '#00c7ff'; icon = '‚Ñπ'; break;
            case 'window': color = '#af52de'; icon = 'üìÖ'; break;
        }

        const logLine = document.createElement('div');
        logLine.style.color = color;
        logLine.style.marginBottom = '8px';
        logLine.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${color};">${icon}</span> ${message}`;
        logContent.appendChild(logLine);
        logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
    }

    function updateProgress(current, total) {
        const percentage = Math.round((current / total) * 100);
        progressBar.style.width = percentage + '%';
        progressPercentage.textContent = percentage + '%';
        progressCount.textContent = `${current}/${total}`;
        progressText.textContent = `Procesando licitaci√≥n ${current} de ${total}`;
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const params = new URLSearchParams(formData).toString();

        // Ocultar formulario y mostrar progreso
        form.parentElement.style.display = 'none';
        progressPanel.style.display = 'block';

        // Iniciar SSE
        const eventSource = new EventSource(`{% url 'tenders:download_tenders_execute' %}?${params}`);

        addLog('üöÄ Conectando con TED API...', 'info');

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            switch(data.type) {
                case 'start':
                    addLog(data.message, 'info');
                    progressEmoji.textContent = 'üîç';
                    progressTitle.textContent = 'Buscando licitaciones...';
                    break;

                case 'window':
                    addLog(`üìÖ Analizando per√≠odo: ${data.start} a ${data.end} (encontradas: ${data.total})`, 'window');
                    break;

                case 'window_result':
                    addLog(`   ‚Üí Nuevas encontradas: ${data.added} (total acumulado: ${data.total})`, 'info');
                    break;

                case 'search_complete':
                    totalToDownload = data.to_download;
                    addLog(`üéØ B√∫squeda completada: ${data.total_found} licitaciones encontradas`, 'success');
                    addLog(`üì• Descargando ${data.to_download} licitaciones...`, 'info');
                    progressEmoji.textContent = '‚¨áÔ∏è';
                    progressTitle.textContent = 'Descargando XMLs...';
                    break;

                case 'download':
                    currentDownload = data.current;
                    updateProgress(data.current, data.total);
                    addLog(`‚¨áÔ∏è  Descargando: ${data.pub_number}`, 'info');
                    break;

                case 'saved':
                    addLog(`‚úì Guardado (${data.saved_count}): ${data.title}`, 'success');
                    break;

                case 'skip':
                    addLog(`‚äò Omitido: ${data.pub_number} - ${data.reason}`, 'warning');
                    break;

                case 'error':
                    addLog(`‚úó Error en ${data.pub_number}: ${data.message}`, 'error');
                    break;

                case 'complete':
                    progressEmoji.textContent = 'üéâ';
                    progressTitle.textContent = '¬°Descarga completada!';
                    progressBar.style.width = '100%';
                    progressPercentage.textContent = '100%';

                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                    addLog(`üéâ DESCARGA COMPLETADA`, 'success');
                    addLog(`   ‚Ä¢ Licitaciones guardadas: ${data.result.saved}`, 'success');
                    addLog(`   ‚Ä¢ XMLs descargados: ${data.result.downloaded}`, 'info');
                    if(data.result.errors > 0) {
                        addLog(`   ‚Ä¢ Errores: ${data.result.errors}`, 'error');
                    }
                    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                    completeActions.style.display = 'block';
                    eventSource.close();
                    break;
            }
        };

        eventSource.onerror = function(error) {
            addLog('‚úó Error de conexi√≥n con el servidor', 'error');
            progressEmoji.textContent = '‚ùå';
            progressTitle.textContent = 'Error en la descarga';
            eventSource.close();
        };
    });
});

// ============================================
// AUTOCOMPLETE TAGS INPUT FOR CPV
// ============================================
class AutocompleteTagsInput {
    constructor(containerId, inputId, dropdownId, hiddenInputId, apiUrl, initialTags = []) {
        this.container = document.getElementById(containerId);
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);
        this.hiddenInput = document.getElementById(hiddenInputId);
        this.apiUrl = apiUrl;
        this.tags = [];
        this.selectedIndex = -1;
        this.searchTimeout = null;
        this.initialTagCodes = initialTags;

        this.init();
    }

    async init() {
        // Load initial tags with proper names from API
        if (this.initialTagCodes) {
            const tagsArray = typeof this.initialTagCodes === 'string'
                ? this.initialTagCodes.split(',').map(t => t.trim()).filter(t => t)
                : this.initialTagCodes;

            // Fetch names for initial tags
            for (const code of tagsArray) {
                await this.loadTagName(code);
            }
        }

        this.renderTags();
        this.updateHiddenInput();

        // Event listeners
        this.input.addEventListener('input', () => this.handleInput());
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.input.addEventListener('focus', () => this.handleFocus());
        this.container.addEventListener('click', (e) => {
            if (e.target === this.container) {
                this.input.focus();
            }
        });

        // Prevent dropdown from closing when clicking inside it
        this.dropdown.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevent blur on input
        });

        // Click outside to close
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target) && !this.dropdown.contains(e.target)) {
                this.hideDropdown();
            }
        });
    }

    async loadTagName(code) {
        try {
            // Search for the code to get its name
            const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(code)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                // Find exact match
                const match = data.results.find(r => r.code === code);
                if (match) {
                    this.tags.push({ code: match.code, name: match.name });
                } else {
                    // Use first result if no exact match
                    this.tags.push({ code: data.results[0].code, name: data.results[0].name });
                }
            } else {
                // If no match found, add with code as name
                this.tags.push({ code, name: code });
            }
        } catch (error) {
            console.error('Error loading tag name:', error);
            // Fallback to code as name
            this.tags.push({ code, name: code });
        }
    }

    handleFocus() {
        // Show suggestions immediately on focus
        const query = this.input.value.trim();
        if (query.length === 0) {
            // Show default suggestions
            this.showDefaultSuggestions();
        } else if (query.length >= 2) {
            // Continue with existing search
            this.handleInput();
        }
    }

    async showDefaultSuggestions() {
        // Show loading
        this.dropdown.innerHTML = '<div class="autocomplete-loading">Cargando sugerencias...</div>';
        this.dropdown.classList.add('active');

        try {
            // Fetch with empty query to get top suggestions
            const response = await fetch(`${this.apiUrl}?q=`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                this.renderDropdown(data.results);
            } else {
                this.dropdown.innerHTML = '<div class="autocomplete-no-results">No hay sugerencias disponibles</div>';
            }
        } catch (error) {
            console.error('Error loading suggestions:', error);
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Error al cargar sugerencias</div>';
        }
    }

    handleInput() {
        const query = this.input.value.trim();

        clearTimeout(this.searchTimeout);

        if (query.length < 2) {
            this.hideDropdown();
            return;
        }

        // Show loading
        this.dropdown.innerHTML = '<div class="autocomplete-loading">Buscando...</div>';
        this.dropdown.classList.add('active');

        // Debounce search
        this.searchTimeout = setTimeout(() => {
            this.search(query);
        }, 300);
    }

    async search(query) {
        try {
            const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                this.renderDropdown(data.results);
            } else {
                this.dropdown.innerHTML = '<div class="autocomplete-no-results">No se encontraron resultados</div>';
            }
        } catch (error) {
            console.error('Error searching:', error);
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Error al buscar</div>';
        }
    }

    renderDropdown(results) {
        this.dropdown.innerHTML = '';
        this.selectedIndex = -1;

        // Filter out already added tags
        const filteredResults = results.filter(item =>
            !this.tags.some(tag => tag.code === item.code)
        );

        if (filteredResults.length === 0) {
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Todas las opciones ya han sido a√±adidas</div>';
            this.dropdown.classList.add('active');
            return;
        }

        filteredResults.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.dataset.index = index;
            div.innerHTML = `
                <div class="autocomplete-code">${item.code}</div>
                <div class="autocomplete-name">${item.name}</div>
            `;

            div.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.addTag(item.code, item.name);
                this.input.value = '';
                // Keep dropdown open by showing default suggestions again
                this.showDefaultSuggestions();
                this.input.focus();
            });

            this.dropdown.appendChild(div);
        });

        this.dropdown.classList.add('active');
    }

    handleKeydown(e) {
        const items = this.dropdown.querySelectorAll('.autocomplete-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
            this.updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
            this.updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (this.selectedIndex >= 0 && items[this.selectedIndex]) {
                items[this.selectedIndex].click();
            } else if (this.input.value.trim()) {
                // Allow custom input
                const customCode = this.input.value.trim();
                this.addTag(customCode, customCode);
                this.input.value = '';
                // Keep dropdown open with default suggestions
                this.showDefaultSuggestions();
            }
        } else if (e.key === 'Escape') {
            this.hideDropdown();
        } else if (e.key === 'Backspace' && this.input.value === '' && this.tags.length > 0) {
            this.removeTag(this.tags[this.tags.length - 1].code);
        }
    }

    updateSelection(items) {
        items.forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    addTag(code, name) {
        // Check if tag already exists
        if (this.tags.some(tag => tag.code === code)) {
            return;
        }

        this.tags.push({ code, name });
        this.renderTags();
        this.updateHiddenInput();
    }

    removeTag(code) {
        this.tags = this.tags.filter(tag => tag.code !== code);
        this.renderTags();
        this.updateHiddenInput();
    }

    renderTags() {
        // Remove existing tags
        this.container.querySelectorAll('.tag').forEach(tag => tag.remove());

        // Add new tags before input
        this.tags.forEach(tag => {
            const tagEl = document.createElement('div');
            tagEl.className = 'tag';
            tagEl.innerHTML = `
                <span>${tag.code} - ${tag.name}</span>
                <span class="tag-remove" data-code="${tag.code}">√ó</span>
            `;

            tagEl.querySelector('.tag-remove').addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeTag(tag.code);
            });

            this.container.insertBefore(tagEl, this.input);
        });
    }

    updateHiddenInput() {
        // Store as comma-separated codes
        this.hiddenInput.value = this.tags.map(tag => tag.code).join(',');
    }

    hideDropdown() {
        this.dropdown.classList.remove('active');
        this.selectedIndex = -1;
    }
}

// Initialize CPV autocomplete for download form
const cpvTagsDownload = new AutocompleteTagsInput(
    'cpvContainerDownload',
    'cpv_input_download',
    'cpvDropdownDownload',
    'cpv_codes_hidden',
    '/empresa/api/autocomplete/cpv/',
    '7226' // Default CPV code
);

// Funci√≥n para borrar todos los XMLs
function confirmDeleteAll() {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas borrar TODOS los XMLs de tu cuenta?\n\nEsta acci√≥n no se puede deshacer.')) {
        const deleteBtn = document.getElementById('deleteAllBtn');
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Borrando...';

        fetch("{% url 'tenders:delete_all_xmls' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úì ${data.deleted_count} licitaciones borradas exitosamente`);
                location.reload();
            } else {
                alert('‚úó Error: ' + data.error);
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="bi bi-trash3"></i> Borrar Todos los XMLs';
            }
        })
        .catch(error => {
            alert('‚úó Error al borrar los XMLs');
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = '<i class="bi bi-trash3"></i> Borrar Todos los XMLs';
        });
    }
}
</script>

<style>
    #logContainer::-webkit-scrollbar {
        width: 8px;
    }
    #logContainer::-webkit-scrollbar-track {
        background: #2d2d2d;
        border-radius: 4px;
    }
    #logContainer::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
    }
    #logContainer::-webkit-scrollbar-thumb:hover {
        background: #777;
    }

    /* Tags/Bubbles para CPV */
    .tags-container {
        border: 2px solid #d2d2d7;
        border-radius: 10px;
        padding: 8px;
        min-height: 50px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        cursor: text;
        transition: all 0.2s;
        position: relative;
    }

    .tags-container:focus-within {
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .tag {
        background: #007aff;
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .tag-remove {
        cursor: pointer;
        font-weight: bold;
        padding: 0 4px;
        border-radius: 50%;
        transition: background 0.2s;
    }

    .tag-remove:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .tag-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 150px;
        padding: 6px;
        font-size: 15px;
    }

    .tag-input::placeholder {
        color: #86868b;
    }

    /* Autocomplete Dropdown */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        margin-top: 4px;
    }

    .autocomplete-dropdown.active {
        display: block;
    }

    .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f7;
        transition: background 0.2s;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background: #f5f5f7;
    }

    .autocomplete-code {
        font-weight: 600;
        color: #007aff;
        font-size: 13px;
    }

    .autocomplete-name {
        color: #1d1d1f;
        font-size: 14px;
        margin-top: 2px;
    }

    .autocomplete-loading {
        padding: 12px 16px;
        text-align: center;
        color: #86868b;
        font-size: 13px;
    }

    .autocomplete-no-results {
        padding: 12px 16px;
        text-align: center;
        color: #86868b;
        font-size: 13px;
    }
</style>
{% endblock %}
