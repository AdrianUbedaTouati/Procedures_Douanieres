{% extends 'core/base.html' %}
{% load static %}

{% block title %}Buscar Licitaciones - TenderAI{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
    }

    .search-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .search-card h2 {
        font-size: 20px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 20px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        font-size: 14px;
        font-weight: 500;
        color: #1d1d1f;
        margin-bottom: 6px;
    }

    .filter-input, .filter-select {
        padding: 10px 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .filter-help {
        font-size: 12px;
        color: #86868b;
        margin-top: 4px;
    }

    .btn-search {
        background: #007aff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-search:hover {
        background: #0051d5;
    }

    .btn-reset {
        background: #f5f5f7;
        color: #1d1d1f;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        margin-left: 12px;
        transition: all 0.2s;
    }

    .btn-reset:hover {
        background: #e8e8ed;
    }

    .results-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .result-item {
        border-bottom: 1px solid #f5f5f7;
        padding: 20px 0;
        transition: background 0.2s;
    }

    .result-item:hover {
        background: #f9f9fb;
        margin: 0 -16px;
        padding: 20px 16px;
        border-radius: 8px;
    }

    .result-item:last-child {
        border-bottom: none;
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 8px;
    }

    .result-title {
        font-size: 16px;
        font-weight: 600;
        color: #007aff;
        text-decoration: none;
        flex: 1;
    }

    .result-title:hover {
        text-decoration: underline;
    }

    .result-date {
        font-size: 13px;
        color: #86868b;
        white-space: nowrap;
        margin-left: 16px;
    }

    .result-buyer {
        font-size: 14px;
        color: #6e6e73;
        margin-bottom: 8px;
    }

    .result-description {
        font-size: 14px;
        color: #1d1d1f;
        margin-bottom: 12px;
        line-height: 1.5;
    }

    .result-meta {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-primary {
        background: #e8f4fd;
        color: #007aff;
    }

    .badge-secondary {
        background: #f5f5f7;
        color: #6e6e73;
    }

    .badge-success {
        background: #d1f4e0;
        color: #28a745;
    }

    .badge-warning {
        background: #fff3cd;
        color: #f0ad4e;
    }

    .result-budget {
        font-size: 14px;
        font-weight: 600;
        color: #007aff;
    }

    .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #86868b;
    }

    .no-results-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
        padding: 20px 0;
    }

    .page-link {
        padding: 8px 14px;
        border: 1px solid #d2d2d7;
        border-radius: 6px;
        color: #1d1d1f;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s;
    }

    .page-link:hover {
        background: #f5f5f7;
        border-color: #007aff;
    }

    .page-link.active {
        background: #007aff;
        color: white;
        border-color: #007aff;
    }

    .results-summary {
        font-size: 14px;
        color: #6e6e73;
        margin-bottom: 16px;
    }

    /* Tags/Bubbles for CPV and NUTS */
    .tags-container {
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        padding: 8px;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        background: white;
        cursor: text;
        position: relative;
    }

    .tags-container:focus-within {
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .tag {
        background: #f5f5f7;
        color: #1d1d1f;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .tag:hover {
        background: #e8e8ed;
    }

    .tag-remove {
        cursor: pointer;
        font-weight: bold;
        color: #86868b;
        font-size: 16px;
        line-height: 1;
        transition: color 0.2s;
    }

    .tag-remove:hover {
        color: #ff3b30;
    }

    .tag-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 150px;
        font-size: 14px;
        padding: 4px;
    }

    /* Autocomplete Dropdown */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        margin-top: 4px;
    }

    .autocomplete-dropdown.active {
        display: block;
    }

    .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f7;
        transition: background 0.2s;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background: #f5f5f7;
    }

    .autocomplete-code {
        font-weight: 600;
        color: #007aff;
        font-size: 13px;
    }

    .autocomplete-name {
        color: #1d1d1f;
        font-size: 14px;
        margin-top: 2px;
    }

    .autocomplete-loading {
        padding: 12px 16px;
        text-align: center;
        color: #86868b;
        font-size: 13px;
    }

    .autocomplete-no-results {
        padding: 12px 16px;
        text-align: center;
        color: #86868b;
        font-size: 13px;
    }

    /* Mode Toggle Buttons */
    .btn-mode {
        background: #f5f5f7;
        color: #1d1d1f;
        border: 2px solid #d2d2d7;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-mode:hover {
        background: #e8e8ed;
        border-color: #007aff;
    }

    .btn-mode.active {
        background: #007aff;
        color: white;
        border-color: #007aff;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <!-- Formulario de B√∫squeda -->
    <div class="search-card">
        <h2>Filtros de B√∫squeda</h2>
        <form method="get" action="{% url 'tenders:list' %}">
            <div class="filter-grid">
                <!-- C√≥digos CPV con Autocompletado -->
                <div class="filter-group">
                    <label class="filter-label" for="cpv_input">C√≥digos CPV</label>
                    <div class="tags-container" id="cpvContainer">
                        <input
                            type="text"
                            class="tag-input"
                            id="cpv_input"
                            placeholder="Buscar por c√≥digo o nombre..."
                            autocomplete="off"
                        >
                        <div class="autocomplete-dropdown" id="cpvDropdown"></div>
                    </div>
                    <input type="hidden" name="cpv_codes" id="cpv_codes_hidden">
                    <span class="filter-help">Busca y selecciona c√≥digos CPV (software, consultor√≠a, etc.)</span>
                </div>

                <!-- Regiones NUTS con Autocompletado -->
                <div class="filter-group">
                    <label class="filter-label" for="nuts_input">Regiones NUTS</label>
                    <div style="margin-bottom: 8px;">
                        <button type="button" id="btnAllRegions" class="btn-mode" style="padding: 6px 12px; font-size: 12px;">
                            üåç Todas las Regiones
                        </button>
                    </div>
                    <div class="tags-container" id="nutsContainer">
                        <input
                            type="text"
                            class="tag-input"
                            id="nuts_input"
                            placeholder="Buscar por regi√≥n..."
                            autocomplete="off"
                        >
                        <div class="autocomplete-dropdown" id="nutsDropdown"></div>
                    </div>
                    <input type="hidden" name="nuts_regions" id="nuts_regions_hidden">
                    <span class="filter-help">Busca regiones espec√≠ficas o selecciona todas</span>
                </div>

                <!-- Tipo de Contrato -->
                <div class="filter-group">
                    <label class="filter-label" for="contract_type">Tipo de Contrato</label>
                    <select class="filter-select" id="contract_type" name="contract_type">
                        <option value="">Todos</option>
                        <option value="services" {% if contract_type == 'services' %}selected{% endif %}>Servicios</option>
                        <option value="supplies" {% if contract_type == 'supplies' %}selected{% endif %}>Suministros</option>
                        <option value="works" {% if contract_type == 'works' %}selected{% endif %}>Obras</option>
                    </select>
                </div>

                <!-- Tipo de Procedimiento -->
                <div class="filter-group">
                    <label class="filter-label" for="procedure_type">Tipo de Procedimiento</label>
                    <select class="filter-select" id="procedure_type" name="procedure_type">
                        <option value="">Todos</option>
                        <option value="open" {% if procedure_type == 'open' %}selected{% endif %}>Abierto</option>
                        <option value="restricted" {% if procedure_type == 'restricted' %}selected{% endif %}>Restringido</option>
                        <option value="negotiated" {% if procedure_type == 'negotiated' %}selected{% endif %}>Negociado</option>
                        <option value="competitive_dialogue" {% if procedure_type == 'competitive_dialogue' %}selected{% endif %}>Di√°logo competitivo</option>
                    </select>
                </div>

                <!-- Presupuesto M√≠nimo -->
                <div class="filter-group">
                    <label class="filter-label" for="budget_min">Presupuesto M√≠nimo (‚Ç¨)</label>
                    <input
                        type="number"
                        class="filter-input"
                        id="budget_min"
                        name="budget_min"
                        value="{{ budget_min }}"
                        placeholder="0"
                        min="0"
                    >
                </div>

                <!-- Presupuesto M√°ximo -->
                <div class="filter-group">
                    <label class="filter-label" for="budget_max">Presupuesto M√°ximo (‚Ç¨)</label>
                    <input
                        type="number"
                        class="filter-input"
                        id="budget_max"
                        name="budget_max"
                        value="{{ budget_max }}"
                        placeholder="Sin l√≠mite"
                        min="0"
                    >
                </div>

                <!-- Modo de Filtro de Fechas -->
                <div class="filter-group" style="grid-column: 1 / -1;">
                    <label class="filter-label">Filtro de Fechas de Publicaci√≥n</label>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <button type="button" id="btnSimpleMode" class="btn-mode active">
                            üìÖ Modo Simple
                        </button>
                        <button type="button" id="btnExpertMode" class="btn-mode">
                            üîß Modo Experto
                        </button>
                    </div>
                </div>

                <!-- Modo Simple: √öltimos X d√≠as -->
                <div class="filter-group" id="simpleModeContainer">
                    <label class="filter-label" for="days_ago">Ofertas publicadas hace</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input
                            type="number"
                            class="filter-input"
                            id="days_ago"
                            name="days_ago"
                            value="{{ days_ago|default:'30' }}"
                            placeholder="30"
                            min="1"
                            max="365"
                            style="flex: 1;"
                        >
                        <span style="color: #6e6e73; font-size: 14px; white-space: nowrap;">d√≠as</span>
                    </div>
                    <span class="filter-help">Busca licitaciones publicadas en los √∫ltimos X d√≠as</span>
                </div>

                <!-- Modo Experto: Fechas espec√≠ficas -->
                <div id="expertModeContainer" style="display: none; grid-column: 1 / -1;">
                    <div class="filter-grid">
                        <!-- Fecha Publicaci√≥n Desde -->
                        <div class="filter-group">
                            <label class="filter-label" for="publication_from">Publicaci√≥n Desde</label>
                            <input
                                type="date"
                                class="filter-input"
                                id="publication_from"
                                name="publication_from"
                                value="{{ publication_from }}"
                            >
                        </div>

                        <!-- Fecha Publicaci√≥n Hasta -->
                        <div class="filter-group">
                            <label class="filter-label" for="publication_to">Publicaci√≥n Hasta</label>
                            <input
                                type="date"
                                class="filter-input"
                                id="publication_to"
                                name="publication_to"
                                value="{{ publication_to }}"
                            >
                        </div>
                    </div>
                </div>

                <!-- Filtro de Fecha L√≠mite (Opcional) -->
                <div class="filter-group" style="grid-column: 1 / -1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <input
                            type="checkbox"
                            id="enable_deadline_filter"
                            style="width: 18px; height: 18px; cursor: pointer;"
                        >
                        <label class="filter-label" for="enable_deadline_filter" style="margin: 0; cursor: pointer;">
                            Especificar Fecha L√≠mite de Presentaci√≥n
                        </label>
                    </div>

                    <div id="deadlineFilterContainer" style="display: none;">
                        <div class="filter-grid">
                            <!-- Fecha L√≠mite Desde -->
                            <div class="filter-group">
                                <label class="filter-label" for="deadline_from">Fecha L√≠mite Desde</label>
                                <input
                                    type="date"
                                    class="filter-input"
                                    id="deadline_from"
                                    name="deadline_from"
                                    value="{{ deadline_from }}"
                                >
                            </div>

                            <!-- Fecha L√≠mite Hasta -->
                            <div class="filter-group">
                                <label class="filter-label" for="deadline_to">Fecha L√≠mite Hasta</label>
                                <input
                                    type="date"
                                    class="filter-input"
                                    id="deadline_to"
                                    name="deadline_to"
                                    value="{{ deadline_to }}"
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" class="btn-search">
                    üîç Buscar Licitaciones
                </button>
                <a href="{% url 'tenders:list' %}" class="btn-reset">
                    ‚úï Limpiar Filtros
                </a>
            </div>
        </form>
    </div>

    <!-- Resultados -->
    {% if tenders %}
    <div class="results-card">
        <div class="results-summary">
            <strong>{{ page_obj.paginator.count }}</strong> licitaciones encontradas
        </div>

        {% for tender in tenders %}
        <div class="result-item">
            <div class="result-header">
                <a href="{% url 'tenders:detail' tender.ojs_notice_id %}" class="result-title">
                    {{ tender.title }}
                </a>
                <span class="result-date">{{ tender.publication_date|date:"d/m/Y" }}</span>
            </div>

            <div class="result-buyer">{{ tender.buyer_name }}</div>

            {% if tender.short_description %}
            <div class="result-description">
                {{ tender.short_description|truncatechars:200 }}
            </div>
            {% endif %}

            <div class="result-meta">
                <span class="badge badge-primary">{{ tender.get_contract_type_display }}</span>
                <span class="badge badge-secondary">{{ tender.get_procedure_type_display }}</span>

                {% if tender.cpv_codes %}
                    {% for cpv in tender.cpv_codes|slice:":3" %}
                    <span class="badge badge-secondary">CPV: {{ cpv }}</span>
                    {% endfor %}
                {% endif %}

                {% if tender.deadline %}
                <span class="badge badge-warning">
                    üìÖ L√≠mite: {{ tender.deadline|date:"d/m/Y H:i" }}
                </span>
                {% endif %}

                {% if tender.budget_amount %}
                <span class="result-budget">
                    üí∞ {{ tender.budget_amount|floatformat:0 }} {{ tender.currency }}
                </span>
                {% endif %}

                <!-- Bot√≥n de borrar -->
                <button
                    onclick="deleteXML('{{ tender.ojs_notice_id }}', '{{ tender.title|escapejs }}')"
                    style="margin-left: auto; padding: 6px 12px; background: #ff3b30; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.background='#cc0000'"
                    onmouseout="this.style.background='#ff3b30'">
                    <i class="bi bi-trash3"></i> Borrar
                </button>
            </div>
        </div>
        {% endfor %}

        <!-- Paginaci√≥n -->
        {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
            <a class="page-link" href="?page=1{{ query_string }}">Primera</a>
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{{ query_string }}">Anterior</a>
            {% endif %}

            <span class="page-link active">
                P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{{ query_string }}">Siguiente</a>
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{{ query_string }}">√öltima</a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% else %}
    <div class="results-card">
        <div class="no-results">
            {% if db_empty %}
                <!-- Base de datos vac√≠a -->
                <div class="no-results-icon">üì≠</div>
                <h3>Base de Datos Vac√≠a</h3>
                <p style="margin: 16px 0; color: #6e6e73;">
                    No hay licitaciones en la base de datos actualmente.
                </p>
                <p style="margin: 16px 0; padding: 16px; background: #e8f4fd; border-radius: 8px; color: #004085;">
                    <strong>üöÄ Obtener Licitaciones</strong><br>
                    Descarga licitaciones directamente desde la API de TED (Tenders Electronic Daily).
                </p>

                <!-- Formulario de descarga -->
                <form method="GET" action="{% url 'tenders:download_tenders' %}" id="downloadForm" style="max-width: 500px; margin: 20px auto; text-align: left;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #1d1d1f;">
                            Per√≠odo de b√∫squeda (d√≠as hacia atr√°s):
                        </label>
                        <input type="number" name="days_back" id="days_back" value="30" min="1" max="365"
                               style="width: 100%; padding: 10px; border: 2px solid #d2d2d7; border-radius: 8px; font-size: 14px;">
                        <small style="color: #6e6e73; display: block; margin-top: 4px;">
                            Busca licitaciones publicadas en los √∫ltimos X d√≠as (recomendado: 30)
                        </small>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #1d1d1f;">
                            M√°ximo de licitaciones a descargar:
                        </label>
                        <input type="number" name="max_download" id="max_download" value="50" min="10" max="200"
                               style="width: 100%; padding: 10px; border: 2px solid #d2d2d7; border-radius: 8px; font-size: 14px;">
                        <small style="color: #6e6e73; display: block; margin-top: 4px;">
                            N√∫mero m√°ximo de licitaciones (recomendado: 50)
                        </small>
                    </div>

                    <button type="submit" style="width: 100%; padding: 14px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        üîÑ Obtener Licitaciones Ahora
                    </button>

                    <p style="margin-top: 12px; font-size: 13px; color: #6e6e73;">
                        ‚è±Ô∏è Este proceso puede tardar varios minutos. Las licitaciones se descargar√°n en segundo plano.
                    </p>
                </form>
            {% elif has_filters %}
                <!-- B√∫squeda sin resultados -->
                <div class="no-results-icon">üîç</div>
                <h3>No se encontraron licitaciones</h3>
                <p style="margin: 16px 0; color: #6e6e73;">
                    No hay licitaciones que coincidan con los filtros aplicados.
                </p>
                <div style="margin: 20px 0; padding: 16px; background: #f5f5f7; border-radius: 8px; text-align: left;">
                    <strong style="color: #1d1d1f;">üí° Sugerencias:</strong>
                    <ul style="margin: 12px 0; padding-left: 24px; text-align: left;">
                        <li>Intenta ampliar el rango de fechas (m√°s d√≠as)</li>
                        <li>Usa menos c√≥digos CPV o selecciona "Todas las Regiones"</li>
                        <li>Elimina algunos filtros restrictivos</li>
                        <li>Verifica que los c√≥digos CPV/NUTS sean correctos</li>
                    </ul>
                </div>
                <p style="margin-top: 20px;">
                    <a href="{% url 'tenders:list' %}" class="btn-reset" style="display: inline-block; text-decoration: none;">
                        ‚úï Limpiar Filtros y Ver Todas
                    </a>
                </p>
            {% else %}
                <!-- Sin b√∫squeda activa -->
                <div class="no-results-icon">üëã</div>
                <h3>Bienvenido al Buscador de Licitaciones</h3>
                <p style="margin: 16px 0; color: #6e6e73;">
                    Usa los filtros de arriba para buscar licitaciones espec√≠ficas.
                </p>
                <div style="margin: 20px 0; padding: 16px; background: #e8f4fd; border-radius: 8px;">
                    <strong style="color: #007aff;">üìå Informaci√≥n:</strong><br>
                    Total de licitaciones disponibles: <strong>{{ total_tenders_in_db }}</strong>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// ============================================
// AUTOCOMPLETE TAGS INPUT
// ============================================
class AutocompleteTagsInput {
    constructor(containerId, inputId, dropdownId, hiddenInputId, apiUrl, initialTags = []) {
        this.container = document.getElementById(containerId);
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);
        this.hiddenInput = document.getElementById(hiddenInputId);
        this.apiUrl = apiUrl;
        this.tags = [];
        this.selectedIndex = -1;
        this.searchTimeout = null;

        // Parse initial tags from comma-separated string
        if (initialTags) {
            const tagsArray = typeof initialTags === 'string'
                ? initialTags.split(',').map(t => t.trim()).filter(t => t)
                : initialTags;
            this.tags = tagsArray.map(code => ({code, name: code}));
        }

        this.init();
    }

    init() {
        this.renderTags();
        this.updateHiddenInput();

        // Event listeners
        this.input.addEventListener('input', () => this.handleInput());
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.input.addEventListener('focus', () => this.handleFocus());
        this.container.addEventListener('click', (e) => {
            if (e.target === this.container) {
                this.input.focus();
            }
        });

        // Prevent dropdown from closing when clicking inside it
        this.dropdown.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevent blur on input
        });

        // Click outside to close
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target) && !this.dropdown.contains(e.target)) {
                this.hideDropdown();
            }
        });
    }

    handleFocus() {
        // Show suggestions immediately on focus
        const query = this.input.value.trim();
        if (query.length === 0) {
            // Show default suggestions
            this.showDefaultSuggestions();
        } else if (query.length >= 2) {
            // Continue with existing search
            this.handleInput();
        }
    }

    async showDefaultSuggestions() {
        // Show loading
        this.dropdown.innerHTML = '<div class="autocomplete-loading">Cargando sugerencias...</div>';
        this.dropdown.classList.add('active');

        try {
            // Fetch with empty query to get top suggestions
            const response = await fetch(`${this.apiUrl}?q=`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                this.renderDropdown(data.results);
            } else {
                this.dropdown.innerHTML = '<div class="autocomplete-no-results">No hay sugerencias disponibles</div>';
            }
        } catch (error) {
            console.error('Error loading suggestions:', error);
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Error al cargar sugerencias</div>';
        }
    }

    handleInput() {
        const query = this.input.value.trim();

        clearTimeout(this.searchTimeout);

        if (query.length < 2) {
            this.hideDropdown();
            return;
        }

        // Show loading
        this.dropdown.innerHTML = '<div class="autocomplete-loading">Buscando...</div>';
        this.dropdown.classList.add('active');

        // Debounce search
        this.searchTimeout = setTimeout(() => {
            this.search(query);
        }, 300);
    }

    async search(query) {
        try {
            const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                this.renderDropdown(data.results);
            } else {
                this.dropdown.innerHTML = '<div class="autocomplete-no-results">No se encontraron resultados</div>';
            }
        } catch (error) {
            console.error('Error searching:', error);
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Error al buscar</div>';
        }
    }

    renderDropdown(results) {
        this.dropdown.innerHTML = '';
        this.selectedIndex = -1;

        // Filter out already added tags
        const filteredResults = results.filter(item =>
            !this.tags.some(tag => tag.code === item.code)
        );

        if (filteredResults.length === 0) {
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Todas las opciones ya han sido a√±adidas</div>';
            this.dropdown.classList.add('active');
            return;
        }

        filteredResults.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.dataset.index = index;
            div.innerHTML = `
                <div class="autocomplete-code">${item.code}</div>
                <div class="autocomplete-name">${item.name}</div>
            `;

            div.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.addTag(item.code, item.name);
                this.input.value = '';
                // Keep dropdown open by showing default suggestions again
                this.showDefaultSuggestions();
                this.input.focus();
            });

            this.dropdown.appendChild(div);
        });

        this.dropdown.classList.add('active');
    }

    handleKeydown(e) {
        const items = this.dropdown.querySelectorAll('.autocomplete-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
            this.updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
            this.updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (this.selectedIndex >= 0 && items[this.selectedIndex]) {
                items[this.selectedIndex].click();
            } else if (this.input.value.trim()) {
                // Allow custom input
                const customCode = this.input.value.trim();
                this.addTag(customCode, customCode);
                this.input.value = '';
                // Keep dropdown open with default suggestions
                this.showDefaultSuggestions();
            }
        } else if (e.key === 'Escape') {
            this.hideDropdown();
        } else if (e.key === 'Backspace' && this.input.value === '' && this.tags.length > 0) {
            this.removeTag(this.tags[this.tags.length - 1].code);
        }
    }

    updateSelection(items) {
        items.forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    addTag(code, name) {
        // Check if tag already exists
        if (this.tags.some(tag => tag.code === code)) {
            return;
        }

        this.tags.push({ code, name });
        this.renderTags();
        this.updateHiddenInput();
    }

    removeTag(code) {
        this.tags = this.tags.filter(tag => tag.code !== code);
        this.renderTags();
        this.updateHiddenInput();
    }

    renderTags() {
        // Remove existing tags
        this.container.querySelectorAll('.tag').forEach(tag => tag.remove());

        // Add new tags before input
        this.tags.forEach(tag => {
            const tagEl = document.createElement('div');
            tagEl.className = 'tag';
            tagEl.innerHTML = `
                <span>${tag.code} - ${tag.name}</span>
                <span class="tag-remove" data-code="${tag.code}">√ó</span>
            `;

            tagEl.querySelector('.tag-remove').addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeTag(tag.code);
            });

            this.container.insertBefore(tagEl, this.input);
        });
    }

    updateHiddenInput() {
        // Store as comma-separated codes
        this.hiddenInput.value = this.tags.map(tag => tag.code).join(',');
    }

    hideDropdown() {
        this.dropdown.classList.remove('active');
        this.selectedIndex = -1;
    }
}

// Initialize CPV autocomplete
const cpvTags = new AutocompleteTagsInput(
    'cpvContainer',
    'cpv_input',
    'cpvDropdown',
    'cpv_codes_hidden',
    '/empresa/api/autocomplete/cpv/',
    '{{ cpv_codes }}'
);

// Initialize NUTS autocomplete
const nutsTags = new AutocompleteTagsInput(
    'nutsContainer',
    'nuts_input',
    'nutsDropdown',
    'nuts_regions_hidden',
    '/empresa/api/autocomplete/nuts/',
    '{{ nuts_regions }}'
);

// ============================================
// ALL REGIONS BUTTON
// ============================================
const btnAllRegions = document.getElementById('btnAllRegions');
const nutsHiddenInput = document.getElementById('nuts_regions_hidden');

btnAllRegions.addEventListener('click', () => {
    // Clear all tags
    nutsTags.tags = [];
    nutsTags.renderTags();

    // Set hidden input to "all"
    nutsHiddenInput.value = 'all';

    // Add visual feedback
    btnAllRegions.classList.add('active');
    btnAllRegions.textContent = '‚úì Todas las Regiones Seleccionadas';

    // Reset after 2 seconds
    setTimeout(() => {
        btnAllRegions.classList.remove('active');
        btnAllRegions.textContent = 'üåç Todas las Regiones';
    }, 2000);
});

// Reset "all" when adding specific regions
const originalAddTag = nutsTags.addTag.bind(nutsTags);
nutsTags.addTag = function(code, name) {
    originalAddTag(code, name);
    // If adding a specific region, ensure we're not in "all" mode
    if (nutsHiddenInput.value === 'all') {
        nutsHiddenInput.value = code;
    }
};

// ============================================
// DATE FILTER MODE TOGGLE
// ============================================
const btnSimpleMode = document.getElementById('btnSimpleMode');
const btnExpertMode = document.getElementById('btnExpertMode');
const simpleModeContainer = document.getElementById('simpleModeContainer');
const expertModeContainer = document.getElementById('expertModeContainer');
const daysAgoInput = document.getElementById('days_ago');
const publicationFromInput = document.getElementById('publication_from');
const publicationToInput = document.getElementById('publication_to');

// Check URL params to determine initial mode
const urlParams = new URLSearchParams(window.location.search);
const hasExpertParams = urlParams.has('publication_from') || urlParams.has('publication_to');

if (hasExpertParams) {
    // Switch to expert mode if expert params are present
    switchToExpertMode();
}

btnSimpleMode.addEventListener('click', () => {
    switchToSimpleMode();
});

btnExpertMode.addEventListener('click', () => {
    switchToExpertMode();
});

function switchToSimpleMode() {
    // Update button states
    btnSimpleMode.classList.add('active');
    btnExpertMode.classList.remove('active');

    // Show/hide containers
    simpleModeContainer.style.display = 'flex';
    expertModeContainer.style.display = 'none';

    // Clear expert mode inputs
    publicationFromInput.value = '';
    publicationToInput.value = '';

    // Enable simple mode input
    daysAgoInput.disabled = false;
}

function switchToExpertMode() {
    // Update button states
    btnSimpleMode.classList.remove('active');
    btnExpertMode.classList.add('active');

    // Show/hide containers
    simpleModeContainer.style.display = 'none';
    expertModeContainer.style.display = 'block';

    // Clear simple mode input
    daysAgoInput.value = '';
    daysAgoInput.disabled = true;

    // Enable expert mode inputs
    publicationFromInput.disabled = false;
    publicationToInput.disabled = false;
}

// ============================================
// DEADLINE FILTER TOGGLE
// ============================================
const enableDeadlineCheckbox = document.getElementById('enable_deadline_filter');
const deadlineFilterContainer = document.getElementById('deadlineFilterContainer');
const deadlineFromInput = document.getElementById('deadline_from');
const deadlineToInput = document.getElementById('deadline_to');

// Check if deadline filters have values to auto-enable
const hasDeadlineParams = urlParams.has('deadline_from') || urlParams.has('deadline_to');
if (hasDeadlineParams) {
    enableDeadlineCheckbox.checked = true;
    deadlineFilterContainer.style.display = 'block';
}

enableDeadlineCheckbox.addEventListener('change', () => {
    if (enableDeadlineCheckbox.checked) {
        deadlineFilterContainer.style.display = 'block';
    } else {
        deadlineFilterContainer.style.display = 'none';
        // Clear deadline inputs when disabled
        deadlineFromInput.value = '';
        deadlineToInput.value = '';
    }
});

// ============================================
// DELETE XML FUNCTION
// ============================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteXML(ojsNoticeId, title) {
    if (confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que deseas borrar esta licitaci√≥n?\n\n"${title}"\n\nEsta acci√≥n no se puede deshacer.`)) {
        const csrftoken = getCookie('csrftoken');

        fetch(`/licitaciones/delete-xml/${ojsNoticeId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úì ${data.message}`);
                location.reload();
            } else {
                alert('‚úó Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚úó Error al borrar la licitaci√≥n');
            console.error('Error:', error);
        });
    }
}
</script>
{% endblock %}
