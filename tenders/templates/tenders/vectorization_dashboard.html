{% extends 'core/base.html' %}

{% block title %}Vectorizaci√≥n - TenderAI{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 40px; margin-top: 40px;">
                <h1 style="font-size: 48px; font-weight: 700; color: #1d1d1f; margin-bottom: 16px;">
                    Vectorizaci√≥n IA
                </h1>
                <p style="font-size: 18px; color: #6e6e73; max-width: 600px; margin: 0 auto;">
                    Indexa tus licitaciones en ChromaDB para usar el chat inteligente con RAG
                </p>
            </div>

            <!-- Card de Estado -->
            <div style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 40px; margin-bottom: 24px;">
                <div style="text-align: center; margin-bottom: 32px;">
                    {% if not has_api_key %}
                        <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <h2 style="font-size: 28px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px;">
                            API Key Requerida
                        </h2>
                        <p style="color: #6e6e73; font-size: 16px;">
                            Por favor, configura tu API key del LLM en tu perfil de usuario.
                        </p>
                        <div style="margin-top: 24px;">
                            <a href="{% url 'core:edit_profile' %}" style="display: inline-block; padding: 14px 32px; background: #007aff; color: white; text-decoration: none; border-radius: 10px; font-weight: 600;">
                                <i class="bi bi-gear"></i> Ir a Configuraci√≥n
                            </a>
                        </div>
                    {% else %}
                        {% if status.is_initialized %}
                            <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                            <h2 style="font-size: 28px; font-weight: 600; color: #34c759; margin-bottom: 12px;">
                                Vectorstore Listo
                            </h2>
                        {% else %}
                            <div style="font-size: 64px; margin-bottom: 16px;">üì¶</div>
                            <h2 style="font-size: 28px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px;">
                                Vectorstore No Inicializado
                            </h2>
                        {% endif %}
                    {% endif %}
                </div>

                {% if has_api_key %}
                    <!-- Estad√≠sticas -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px;">
                        <div style="background: #f5f5f7; padding: 24px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #1d1d1f; margin-bottom: 8px;">
                                {{ tenders_with_xml }}
                            </div>
                            <div style="color: #6e6e73; font-size: 14px; font-weight: 600;">
                                Licitaciones con XML
                            </div>
                        </div>

                        <div style="background: #f5f5f7; padding: 24px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #007aff; margin-bottom: 8px;">
                                {{ status.num_chunks|default:0 }}
                            </div>
                            <div style="color: #6e6e73; font-size: 14px; font-weight: 600;">
                                Chunks Indexados
                            </div>
                        </div>

                        <div style="background: #f5f5f7; padding: 24px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #34c759; margin-bottom: 8px;">
                                {% if status.is_initialized %}‚úì{% else %}‚úó{% endif %}
                            </div>
                            <div style="color: #6e6e73; font-size: 14px; font-weight: 600;">
                                Estado ChromaDB
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n detallada -->
                    <div style="background: #f5f5f7; border-radius: 12px; padding: 20px; margin-bottom: 32px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px;">
                            <i class="bi bi-info-circle"></i> Informaci√≥n del Vectorstore
                        </h3>
                        <div style="font-family: 'Courier New', monospace; font-size: 13px; color: #1d1d1f;">
                            <div style="margin-bottom: 8px;">
                                <strong>Colecci√≥n:</strong> {{ status.collection_name|default:"eforms_notices" }}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Directorio:</strong> {{ status.persist_directory|default:"-" }}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Estado:</strong> <span style="color: {% if status.is_initialized %}#34c759{% else %}#ff9500{% endif %}; font-weight: 600;">{{ status.message }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Explicaci√≥n de Indexar -->
                    <div style="background: #e3f2fd; border-left: 4px solid #007aff; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: start;">
                            <i class="bi bi-info-circle-fill" style="font-size: 20px; color: #007aff; margin-right: 12px; margin-top: 2px;"></i>
                            <div>
                                <strong style="color: #1976d2; font-size: 14px;">Sobre la indexaci√≥n</strong>
                                <p style="margin: 4px 0 0 0; color: #1976d2; font-size: 13px;">
                                    Al hacer clic en "Indexar", se crear√° una nueva indexaci√≥n de todas tus licitaciones.
                                    <strong>La indexaci√≥n anterior permanecer√° activa</strong> hasta que la nueva se complete exitosamente.
                                    Si cancelas o hay un error, la anterior seguir√° disponible.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- Bot√≥n Indexar -->
                        <button
                            id="indexBtn"
                            type="button"
                            {% if tenders_with_xml == 0 %}disabled{% endif %}
                            style="padding: 16px; background: {% if tenders_with_xml == 0 %}#d2d2d7{% else %}linear-gradient(135deg, #007aff 0%, #0051d5 100%){% endif %}; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: {% if tenders_with_xml == 0 %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s; box-shadow: {% if tenders_with_xml > 0 %}0 4px 12px rgba(0, 122, 255, 0.3){% else %}none{% endif %};">
                            <i class="bi bi-play-circle"></i> Indexar
                        </button>

                        <!-- Bot√≥n Limpiar -->
                        <button
                            id="clearBtn"
                            type="button"
                            {% if not status.is_initialized %}disabled{% endif %}
                            style="padding: 16px; background: {% if not status.is_initialized %}#d2d2d7{% else %}#ff3b30{% endif %}; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: {% if not status.is_initialized %}not-allowed{% else %}pointer{% endif %}; transition: all 0.3s;">
                            <i class="bi bi-trash3"></i> Borrar Vectorstore
                        </button>
                    </div>

                    {% if tenders_with_xml == 0 %}
                    <div style="margin-top: 24px; padding: 16px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <div style="display: flex; align-items: start;">
                            <i class="bi bi-exclamation-triangle" style="font-size: 20px; color: #856404; margin-right: 12px; margin-top: 2px;"></i>
                            <div>
                                <strong style="color: #856404; font-size: 14px;">No hay licitaciones para indexar</strong>
                                <p style="margin: 4px 0 0 0; color: #856404; font-size: 13px;">
                                    Primero descarga algunas licitaciones desde la secci√≥n "Obtener".
                                </p>
                                <div style="margin-top: 12px;">
                                    <a href="{% url 'tenders:download_tenders' %}" style="color: #856404; text-decoration: underline; font-weight: 600;">
                                        Ir a Obtener Licitaciones ‚Üí
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Panel de progreso (oculto inicialmente) -->
            <div id="progressPanel" style="display: none; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 40px; margin-bottom: 24px;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 64px; margin-bottom: 16px;" id="progressEmoji">‚è≥</div>
                    <h2 style="font-size: 28px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px;" id="progressTitle">
                        Indexando...
                    </h2>
                </div>

                <!-- Panel de costes en tiempo real -->
                <div id="costPanel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; margin-bottom: 24px; color: white;">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin: 0;">üí∞ Uso de Tokens y Costes</h3>
                        <p style="font-size: 12px; margin: 4px 0 0 0; opacity: 0.9;">(Aproximado)</p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">TOKENS</div>
                            <div id="totalTokens" style="font-size: 24px; font-weight: 700;">0</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">COSTE</div>
                            <div id="totalCost" style="font-size: 24px; font-weight: 700;">‚Ç¨0.00</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">CHUNKS</div>
                            <div id="totalChunks" style="font-size: 24px; font-weight: 700;">0</div>
                        </div>
                    </div>
                </div>

                <!-- Barra de progreso -->
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #1d1d1f;" id="progressText">Iniciando...</span>
                        <span style="font-weight: 600; color: #007aff;" id="progressPercentage">0%</span>
                    </div>
                    <div style="width: 100%; height: 24px; background: #f5f5f7; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="progressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #007aff 0%, #00c7ff 100%); border-radius: 12px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;">
                            <span style="color: white; font-size: 12px; font-weight: 600;" id="progressCount"></span>
                        </div>
                    </div>
                </div>

                <!-- Log de actividad -->
                <div style="background: #1d1d1f; border-radius: 12px; padding: 24px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; color: #00ff00;" id="logContainer">
                    <div id="logContent"></div>
                </div>

                <!-- Botones de acci√≥n -->
                <div style="margin-top: 24px; text-align: center; display: flex; gap: 16px; justify-content: center;">
                    <!-- Bot√≥n Cancelar (visible durante indexaci√≥n) -->
                    <button id="cancelBtn" style="display: inline-block; padding: 14px 32px; background: #ff3b30; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="bi bi-x-circle"></i> Cancelar Indexaci√≥n
                    </button>

                    <!-- Bot√≥n para volver al dashboard (visible al completar) -->
                    <button id="reloadBtn" style="display: none; padding: 14px 32px; background: #34c759; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="bi bi-arrow-clockwise"></i> Volver al Dashboard
                    </button>
                </div>
            </div>

            <!-- Card de ayuda -->
            <div style="background: #f5f5f7; border-radius: 16px; padding: 32px; margin-bottom: 40px;">
                <h3 style="font-size: 20px; font-weight: 600; color: #1d1d1f; margin-bottom: 16px;">
                    <i class="bi bi-question-circle"></i> ¬øQu√© es la vectorizaci√≥n?
                </h3>
                <p style="color: #6e6e73; font-size: 15px; line-height: 1.6; margin-bottom: 16px;">
                    La vectorizaci√≥n convierte tus licitaciones en embeddings (vectores) que permiten b√∫squedas sem√°nticas inteligentes.
                    Este proceso es necesario para que el <strong>Chat IA</strong> pueda encontrar informaci√≥n relevante en tus documentos.
                </p>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 20px;">
                    <div style="background: white; padding: 16px; border-radius: 10px;">
                        <div style="color: #007aff; font-size: 24px; margin-bottom: 8px;">üß†</div>
                        <strong style="color: #1d1d1f; font-size: 14px;">B√∫squeda Sem√°ntica</strong>
                        <p style="color: #6e6e73; font-size: 13px; margin-top: 4px;">
                            El chat comprende el significado de tus preguntas, no solo palabras clave.
                        </p>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 10px;">
                        <div style="color: #34c759; font-size: 24px; margin-bottom: 8px;">üéØ</div>
                        <strong style="color: #1d1d1f; font-size: 14px;">RAG (Retrieval-Augmented Generation)</strong>
                        <p style="color: #6e6e73; font-size: 13px; margin-top: 4px;">
                            Respuestas precisas basadas en tus documentos reales, no en conocimiento gen√©rico.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const indexBtn = document.getElementById('indexBtn');
    const clearBtn = document.getElementById('clearBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const progressPanel = document.getElementById('progressPanel');
    const logContent = document.getElementById('logContent');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressCount = document.getElementById('progressCount');
    const progressTitle = document.getElementById('progressTitle');
    const progressEmoji = document.getElementById('progressEmoji');
    const totalTokens = document.getElementById('totalTokens');
    const totalCost = document.getElementById('totalCost');
    const totalChunks = document.getElementById('totalChunks');

    let totalToIndex = 0;
    let currentIndex = 0;
    let eventSource = null;
    let accumulatedTokens = 0;
    let accumulatedCost = 0.0;
    let accumulatedChunks = 0;

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function formatCost(cost) {
        if (cost === 0) return '‚Ç¨0.00 (Gratis)';
        if (cost < 0.01) return '‚Ç¨' + cost.toFixed(4);
        if (cost < 1) return '‚Ç¨' + cost.toFixed(3);
        return '‚Ç¨' + cost.toFixed(2);
    }

    function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        let color = '#00ff00';
        let icon = '‚Ä¢';

        switch(type) {
            case 'success': color = '#34c759'; icon = '‚úì'; break;
            case 'error': color = '#ff3b30'; icon = '‚úó'; break;
            case 'warning': color = '#ffcc00'; icon = '‚ö†'; break;
            case 'info': color = '#00c7ff'; icon = '‚Ñπ'; break;
        }

        const logLine = document.createElement('div');
        logLine.style.color = color;
        logLine.style.marginBottom = '8px';
        logLine.innerHTML = `<span style="color: #888;">[${timestamp}]</span> <span style="color: ${color};">${icon}</span> ${message}`;
        logContent.appendChild(logLine);
        logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
    }

    function updateProgress(current, total) {
        const percentage = Math.round((current / total) * 100);
        progressBar.style.width = percentage + '%';
        progressPercentage.textContent = percentage + '%';
        progressCount.textContent = `${current}/${total}`;
        progressText.textContent = `Procesando licitaci√≥n ${current} de ${total}`;
    }

    function updateCostPanel(tokens, cost, chunks) {
        accumulatedTokens = tokens || accumulatedTokens;
        accumulatedCost = cost || accumulatedCost;
        accumulatedChunks = chunks || accumulatedChunks;

        totalTokens.textContent = formatNumber(accumulatedTokens);
        totalCost.textContent = formatCost(accumulatedCost);
        totalChunks.textContent = formatNumber(accumulatedChunks);
    }

    // Bot√≥n Indexar
    if (indexBtn) {
        indexBtn.addEventListener('click', function() {
            // Reset counters
            accumulatedTokens = 0;
            accumulatedCost = 0.0;
            accumulatedChunks = 0;
            updateCostPanel(0, 0.0, 0);

            // Ocultar card de estado y mostrar progreso
            this.closest('.col-lg-10').querySelector('div[style*="background: white"]').style.display = 'none';
            progressPanel.style.display = 'block';
            cancelBtn.style.display = 'inline-block';
            reloadBtn.style.display = 'none';

            // Iniciar SSE
            eventSource = new EventSource("{% url 'tenders:index_all_tenders' %}");

            addLog('üöÄ Iniciando indexaci√≥n de licitaciones...', 'info');
            progressEmoji.textContent = 'üîÑ';
            progressTitle.textContent = 'Indexando en ChromaDB...';

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                switch(data.type) {
                    case 'start':
                        addLog(data.message, 'info');
                        totalToIndex = data.total;
                        addLog(`üìä Total de licitaciones a indexar: ${data.total}`, 'info');
                        break;

                    case 'info':
                        addLog(data.message, 'info');
                        break;

                    case 'progress':
                        currentIndex = data.current;
                        updateProgress(data.current, data.total);
                        updateCostPanel(data.total_tokens, data.total_cost_eur, null);
                        addLog(`üîÑ Indexando ${data.tender_id}...`, 'info');
                        break;

                    case 'indexed':
                        updateCostPanel(data.total_tokens, data.total_cost_eur, data.total_tokens > 0 ? accumulatedChunks + data.chunks : accumulatedChunks);
                        addLog(data.message, 'success');
                        break;

                    case 'error':
                        const errorContext = data.tender_id || 'indexaci√≥n';
                        const errorMsg = data.error || data.message || 'Error desconocido';
                        addLog(`‚úó Error en ${errorContext}: ${errorMsg}`, 'error');
                        break;

                    case 'cancelled':
                        progressEmoji.textContent = '‚ö†Ô∏è';
                        progressTitle.textContent = 'Indexaci√≥n Cancelada';
                        addLog(data.message, 'warning');
                        cancelBtn.style.display = 'none';
                        reloadBtn.style.display = 'inline-block';
                        eventSource.close();
                        break;

                    case 'fatal_error':
                        progressEmoji.textContent = '‚ùå';
                        progressTitle.textContent = 'Error en la indexaci√≥n';
                        addLog(`‚úó Error fatal: ${data.error}`, 'error');
                        cancelBtn.style.display = 'none';
                        reloadBtn.style.display = 'inline-block';
                        eventSource.close();
                        break;

                    case 'complete':
                        progressEmoji.textContent = 'üéâ';
                        progressTitle.textContent = '¬°Indexaci√≥n completada!';
                        progressBar.style.width = '100%';
                        progressPercentage.textContent = '100%';

                        const result = data.result;
                        updateCostPanel(result.total_tokens, result.total_cost_eur, result.total_chunks);

                        addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                        addLog(`üéâ INDEXACI√ìN COMPLETADA`, 'success');
                        addLog(`   ‚Ä¢ Licitaciones indexadas: ${result.indexed}`, 'success');
                        addLog(`   ‚Ä¢ Total de chunks: ${result.total_chunks}`, 'info');
                        addLog(`   ‚Ä¢ Tokens utilizados: ${formatNumber(result.total_tokens)}`, 'info');
                        addLog(`   ‚Ä¢ Coste total: ${formatCost(result.total_cost_eur)}`, 'info');
                        if(result.errors > 0) {
                            addLog(`   ‚Ä¢ Errores: ${result.errors}`, 'error');
                        }
                        addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                        cancelBtn.style.display = 'none';
                        reloadBtn.style.display = 'inline-block';
                        eventSource.close();
                        break;
                }
            };

            eventSource.onerror = function(error) {
                addLog('‚úó Error de conexi√≥n con el servidor', 'error');
                progressEmoji.textContent = '‚ùå';
                progressTitle.textContent = 'Error en la indexaci√≥n';
                cancelBtn.style.display = 'none';
                reloadBtn.style.display = 'inline-block';
                eventSource.close();
            };
        });
    }

    // Bot√≥n Cancelar
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas cancelar la indexaci√≥n?\n\nLa indexaci√≥n se detendr√° despu√©s del chunk actual.\nLa colecci√≥n anterior permanecer√° activa.')) {
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> Cancelando...';

                fetch("{% url 'tenders:cancel_indexing' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog(`‚ö†Ô∏è ${data.message}`, 'warning');
                    } else {
                        addLog('‚úó Error al cancelar: ' + data.error, 'error');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-x-circle"></i> Cancelar Indexaci√≥n';
                    }
                })
                .catch(error => {
                    addLog('‚úó Error al solicitar cancelaci√≥n', 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-x-circle"></i> Cancelar Indexaci√≥n';
                });
            }
        });
    }

    // Bot√≥n Reload
    if (reloadBtn) {
        reloadBtn.addEventListener('click', function() {
            location.reload();
        });
    }

    // Bot√≥n Limpiar
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas borrar el vectorstore?\n\nEsta acci√≥n eliminar√° todos los chunks indexados y tendr√°s que volver a indexar.')) {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Borrando...';

                fetch("{% url 'tenders:clear_vectorstore' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úì ${data.message}`);
                        location.reload();
                    } else {
                        alert('‚úó Error: ' + data.error);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-trash3"></i> Borrar Vectorstore';
                    }
                })
                .catch(error => {
                    alert('‚úó Error al borrar el vectorstore');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-trash3"></i> Borrar Vectorstore';
                });
            }
        });
    }
});
</script>

<style>
    #logContainer::-webkit-scrollbar {
        width: 8px;
    }
    #logContainer::-webkit-scrollbar-track {
        background: #2d2d2d;
        border-radius: 4px;
    }
    #logContainer::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
    }
    #logContainer::-webkit-scrollbar-thumb:hover {
        background: #777;
    }
</style>
{% endblock %}
