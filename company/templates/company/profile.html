{% extends 'core/base.html' %}
{% load static %}

{% block title %}Mi Empresa{% endblock %}

{% block extra_css %}
<style>
    .company-profile-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .profile-card {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .profile-card h2 {
        font-size: 24px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }

    .profile-card .subtitle {
        color: #86868b;
        font-size: 14px;
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-weight: 500;
        color: #1d1d1f;
        margin-bottom: 8px;
        font-size: 15px;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    textarea.form-input {
        resize: vertical;
        min-height: 120px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .help-text {
        font-size: 13px;
        color: #86868b;
        margin-top: 6px;
    }

    /* Tags Input Styling */
    .tags-container {
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        padding: 8px;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        transition: all 0.2s;
        background: white;
        cursor: text;
        position: relative;
    }

    .tags-container:focus-within {
        border-color: #007aff;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    .tag {
        background: #f5f5f7;
        color: #1d1d1f;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .tag:hover {
        background: #e8e8ed;
    }

    .tag-remove {
        cursor: pointer;
        color: #86868b;
        font-weight: 600;
        font-size: 16px;
        line-height: 1;
        padding: 0 2px;
    }

    .tag-remove:hover {
        color: #ff3b30;
    }

    .tag-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 15px;
        padding: 6px 4px;
    }

    .budget-range {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .btn-primary {
        background: #007aff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
    }

    .btn-primary:hover {
        background: #0051d5;
    }

    .btn-secondary {
        background: #f5f5f7;
        color: #1d1d1f;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: #e8e8ed;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    .alert-success {
        background: #d1f2e6;
        color: #00843d;
        border: 1px solid #34c759;
    }

    .alert-error {
        background: #fde8e8;
        color: #c41e3a;
        border: 1px solid #ff3b30;
    }

    .extract-btn-container {
        margin-top: 12px;
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007aff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .spinner.active {
        display: inline-block;
    }

    /* Autocomplete Dropdown */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        margin-top: 4px;
    }

    .autocomplete-dropdown.active {
        display: block;
    }

    .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f7;
        font-size: 14px;
        transition: background 0.2s;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background: #f5f5f7;
    }

    .autocomplete-item.selected {
        background: #e8f4fd;
    }

    .autocomplete-code {
        font-weight: 600;
        color: #007aff;
        font-size: 13px;
    }

    .autocomplete-name {
        color: #1d1d1f;
        font-size: 14px;
    }

    .autocomplete-loading,
    .autocomplete-no-results {
        padding: 12px 16px;
        text-align: center;
        color: #86868b;
        font-size: 13px;
    }

    .tag-code {
        opacity: 0.7;
        font-size: 12px;
        margin-left: 4px;
    }

    /* Position relative for tags container to position dropdown */
    .form-group {
        position: relative;
    }

    /* Ensure tags container positioning for dropdown */
    .tags-container {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="company-profile-container">
    <div class="profile-card">
        <h2>Mi Empresa</h2>
        <p class="subtitle">Completa tu perfil para recibir recomendaciones personalizadas de licitaciones</p>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" id="profileForm">
            {% csrf_token %}

            <!-- Nombre de la Empresa -->
            <div class="form-group">
                <label class="form-label" for="id_company_name">Nombre de la empresa *</label>
                <input
                    type="text"
                    class="form-input"
                    id="id_company_name"
                    name="company_name"
                    value="{{ form.company_name.value|default:'' }}"
                    required
                >
            </div>

            <!-- Descripción Libre -->
            <div class="form-group">
                <label class="form-label" for="id_company_description_text">Cuéntanos sobre tu empresa</label>
                <textarea
                    class="form-input"
                    id="id_company_description_text"
                    name="company_description_text"
                    placeholder="Ejemplo: Somos una empresa de desarrollo de software especializada en soluciones cloud. Contamos con 15 empleados y trabajamos principalmente en Madrid y Barcelona. Ofrecemos servicios de consultoría tecnológica, desarrollo web y aplicaciones móviles..."
                >{{ form.company_description_text.value|default:'' }}</textarea>
                <p class="help-text">Describe tu empresa, qué hacéis, en qué sectores trabajáis, ubicación, etc. Esta información ayudará a encontrar las licitaciones más relevantes.</p>

                <div class="extract-btn-container">
                    <button type="button" class="btn-secondary" id="extractBtn">
                        Autocompletar campos
                    </button>
                    <div class="spinner" id="extractSpinner"></div>
                </div>
            </div>

            <!-- Número de Empleados -->
            <div class="form-group">
                <label class="form-label" for="id_employees">Número de empleados</label>
                <input
                    type="number"
                    class="form-input"
                    id="id_employees"
                    name="employees"
                    value="{{ form.employees.value|default:'' }}"
                    min="1"
                >
            </div>

            <!-- Códigos CPV (Tags con Autocomplete) -->
            <div class="form-group">
                <label class="form-label" for="cpv_input">Códigos CPV de interés (Sectores)</label>
                <div class="tags-container" id="cpvContainer" data-field="preferred_cpv_codes">
                    <input
                        type="text"
                        class="tag-input"
                        id="cpv_input"
                        placeholder="Buscar por código o nombre..."
                        autocomplete="off"
                    >
                    <div class="autocomplete-dropdown" id="cpvDropdown"></div>
                </div>
                <input type="hidden" name="preferred_cpv_codes" id="preferred_cpv_codes_hidden">
                <p class="help-text">Busca códigos CPV relacionados con tu actividad</p>
            </div>

            <!-- Regiones NUTS (Tags con Autocomplete) -->
            <div class="form-group">
                <label class="form-label" for="nuts_input">Regiones de interés (NUTS)</label>
                <div class="tags-container" id="nutsContainer" data-field="preferred_nuts_regions">
                    <input
                        type="text"
                        class="tag-input"
                        id="nuts_input"
                        placeholder="Buscar por código o nombre..."
                        autocomplete="off"
                    >
                    <div class="autocomplete-dropdown" id="nutsDropdown"></div>
                </div>
                <input type="hidden" name="preferred_nuts_regions" id="preferred_nuts_regions_hidden">
                <p class="help-text">Busca regiones NUTS (Ej: ES30 - Madrid, ES51 - Barcelona)</p>
            </div>

            <!-- Rango de Presupuesto -->
            <div class="form-group">
                <label class="form-label">Rango de presupuesto de proyectos</label>
                <div class="budget-range">
                    <div>
                        <input
                            type="number"
                            class="form-input"
                            id="id_budget_min"
                            name="budget_min"
                            placeholder="Mínimo (€)"
                            min="0"
                            value="{{ budget_min }}"
                        >
                    </div>
                    <div>
                        <input
                            type="number"
                            class="form-input"
                            id="id_budget_max"
                            name="budget_max"
                            placeholder="Máximo (€)"
                            min="0"
                            value="{{ budget_max }}"
                        >
                    </div>
                </div>
            </div>

            <!-- Botón de Guardar -->
            <button type="submit" class="btn-primary">
                Guardar Perfil
            </button>
        </form>
    </div>
</div>

<script>
// ================================================
// AUTOCOMPLETE TAGS INPUT FUNCTIONALITY
// ================================================
class AutocompleteTagsInput {
    constructor(containerId, inputId, dropdownId, hiddenInputId, apiUrl, initialTags = []) {
        this.container = document.getElementById(containerId);
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);
        this.hiddenInput = document.getElementById(hiddenInputId);
        this.apiUrl = apiUrl;
        this.tags = [];
        this.selectedIndex = -1;
        this.searchTimeout = null;
        this.initialTagCodes = initialTags;

        this.init();
    }

    async init() {
        // Load initial tags with proper names from API
        if (this.initialTagCodes && this.initialTagCodes.length > 0) {
            const tagsArray = Array.isArray(this.initialTagCodes) ? this.initialTagCodes : [];

            // Fetch names for initial tags
            for (const code of tagsArray) {
                if (code) {
                    await this.loadTagName(code);
                }
            }
        }

        this.renderTags();
        this.updateHiddenInput();

        // Event listeners
        this.input.addEventListener('input', () => this.handleInput());
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.input.addEventListener('focus', () => this.handleFocus());

        // Click on container focuses input
        this.container.addEventListener('click', (e) => {
            if (e.target === this.container) {
                this.input.focus();
            }
        });

        // Prevent dropdown from closing when clicking inside it
        this.dropdown.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevent blur on input
        });

        // Click outside to close
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target) && !this.dropdown.contains(e.target)) {
                this.hideDropdown();
            }
        });
    }

    async loadTagName(code) {
        try {
            // Search for the code to get its name
            const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(code)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                // Find exact match
                const match = data.results.find(r => r.code === code);
                if (match) {
                    this.tags.push({ code: match.code, name: match.name });
                } else {
                    // Use first result if no exact match
                    this.tags.push({ code: data.results[0].code, name: data.results[0].name });
                }
            } else {
                // If no match found, add with code as name
                this.tags.push({ code, name: code });
            }
        } catch (error) {
            console.error('Error loading tag name:', error);
            // Fallback to code as name
            this.tags.push({ code, name: code });
        }
    }

    handleFocus() {
        // Show suggestions immediately on focus
        const query = this.input.value.trim();
        if (query.length === 0) {
            this.showDefaultSuggestions();
        } else if (query.length >= 2) {
            this.handleInput();
        }
    }

    async showDefaultSuggestions() {
        this.dropdown.innerHTML = '<div class="autocomplete-loading">Cargando sugerencias...</div>';
        this.dropdown.classList.add('active');

        try {
            const response = await fetch(`${this.apiUrl}?q=`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                this.renderDropdown(data.results);
            } else {
                this.dropdown.innerHTML = '<div class="autocomplete-no-results">No hay sugerencias disponibles</div>';
            }
        } catch (error) {
            console.error('Error fetching suggestions:', error);
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Error al cargar sugerencias</div>';
        }
    }

    handleInput() {
        const query = this.input.value.trim();

        // Clear previous timeout
        if (this.searchTimeout) {
            clearTimeout(this.searchTimeout);
        }

        if (query.length < 2) {
            if (query.length === 0) {
                this.showDefaultSuggestions();
            } else {
                this.hideDropdown();
            }
            return;
        }

        // Debounce search
        this.searchTimeout = setTimeout(() => this.search(query), 300);
    }

    async search(query) {
        this.dropdown.innerHTML = '<div class="autocomplete-loading">Buscando...</div>';
        this.dropdown.classList.add('active');

        try {
            const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                this.renderDropdown(data.results);
            } else {
                this.dropdown.innerHTML = '<div class="autocomplete-no-results">No se encontraron resultados</div>';
            }
        } catch (error) {
            console.error('Error searching:', error);
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Error en la búsqueda</div>';
        }
    }

    renderDropdown(results) {
        // Filter out already added tags
        const availableResults = results.filter(r => !this.tags.some(t => t.code === r.code));

        if (availableResults.length === 0) {
            this.dropdown.innerHTML = '<div class="autocomplete-no-results">Todos los resultados ya están agregados</div>';
            this.dropdown.classList.add('active');
            return;
        }

        this.dropdown.innerHTML = availableResults.map((result, index) => `
            <div class="autocomplete-item" data-index="${index}" data-code="${result.code}" data-name="${result.name}">
                <span class="autocomplete-code">${result.code}</span>
                <span class="autocomplete-name">${result.name}</span>
            </div>
        `).join('');

        // Add click listeners
        this.dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const code = item.dataset.code;
                const name = item.dataset.name;
                this.addTag(code, name);
                this.input.value = '';
                // Keep dropdown open by showing default suggestions again
                this.showDefaultSuggestions();
                this.input.focus();
            });
        });

        this.dropdown.classList.add('active');
        this.selectedIndex = -1;
    }

    handleKeydown(e) {
        const items = this.dropdown.querySelectorAll('.autocomplete-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
            this.updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
            this.updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (this.selectedIndex >= 0 && items[this.selectedIndex]) {
                items[this.selectedIndex].click();
            } else if (this.input.value.trim()) {
                // Allow custom input
                const customCode = this.input.value.trim();
                this.addTag(customCode, customCode);
                this.input.value = '';
                // Keep dropdown open with default suggestions
                this.showDefaultSuggestions();
            }
        } else if (e.key === 'Escape') {
            this.hideDropdown();
        } else if (e.key === 'Backspace' && this.input.value === '' && this.tags.length > 0) {
            // Remove last tag on backspace when input is empty
            this.removeTag(this.tags[this.tags.length - 1].code);
        }
    }

    updateSelection() {
        const items = this.dropdown.querySelectorAll('.autocomplete-item');
        items.forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    addTag(code, name) {
        // Check if tag already exists
        if (this.tags.some(tag => tag.code === code)) {
            return;
        }

        this.tags.push({ code, name });
        this.renderTags();
        this.updateHiddenInput();
    }

    removeTag(code) {
        this.tags = this.tags.filter(tag => tag.code !== code);
        this.renderTags();
        this.updateHiddenInput();
    }

    renderTags() {
        // Remove existing tags
        this.container.querySelectorAll('.tag').forEach(tag => tag.remove());

        // Add new tags before input
        this.tags.forEach(tag => {
            const tagEl = document.createElement('div');
            tagEl.className = 'tag';
            tagEl.innerHTML = `
                <span>${tag.code} - ${tag.name}</span>
                <span class="tag-remove" data-code="${tag.code}">×</span>
            `;

            tagEl.querySelector('.tag-remove').addEventListener('click', (e) => {
                e.stopPropagation();
                this.removeTag(tag.code);
            });

            this.container.insertBefore(tagEl, this.input);
        });
    }

    updateHiddenInput() {
        // Store as JSON array of codes for compatibility
        this.hiddenInput.value = JSON.stringify(this.tags.map(tag => tag.code));
    }

    hideDropdown() {
        this.dropdown.classList.remove('active');
        this.selectedIndex = -1;
    }

    setTags(codes) {
        // Clear existing tags
        this.tags = [];

        // Load new tags
        if (codes && codes.length > 0) {
            codes.forEach(async (code) => {
                await this.loadTagName(code);
                this.renderTags();
                this.updateHiddenInput();
            });
        } else {
            this.renderTags();
            this.updateHiddenInput();
        }
    }
}

// Initialize autocomplete tags inputs
const cpvInput = new AutocompleteTagsInput(
    'cpvContainer',
    'cpv_input',
    'cpvDropdown',
    'preferred_cpv_codes_hidden',
    '/empresa/api/autocomplete/cpv/',
    {{ cpv_codes_json|safe }}
);

const nutsInput = new AutocompleteTagsInput(
    'nutsContainer',
    'nuts_input',
    'nutsDropdown',
    'preferred_nuts_regions_hidden',
    '/empresa/api/autocomplete/nuts/',
    {{ nuts_regions_json|safe }}
);

// ================================================
// AUTO-EXTRACT FUNCTIONALITY
// ================================================
document.getElementById('extractBtn').addEventListener('click', async function() {
    const text = document.getElementById('id_company_description_text').value.trim();

    if (!text) {
        alert('Por favor, escribe una descripción de tu empresa primero.');
        return;
    }

    const btn = this;
    const spinner = document.getElementById('extractSpinner');
    btn.disabled = true;
    spinner.classList.add('active');
    btn.textContent = 'Procesando...';

    try {
        const formData = new FormData();
        formData.append('company_text', text);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "company:extract_info" %}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Fill company name
            if (data.data.company_name) {
                document.getElementById('id_company_name').value = data.data.company_name;
            }

            // Fill employees
            if (data.data.employees) {
                document.getElementById('id_employees').value = data.data.employees;
            }

            // Fill CPV codes
            if (data.data.preferred_cpv_codes && data.data.preferred_cpv_codes.length > 0) {
                cpvInput.setTags(data.data.preferred_cpv_codes);
            }

            // Fill NUTS regions
            if (data.data.preferred_nuts_regions && data.data.preferred_nuts_regions.length > 0) {
                nutsInput.setTags(data.data.preferred_nuts_regions);
            }

            // Fill budget
            if (data.data.budget_min) {
                document.getElementById('id_budget_min').value = data.data.budget_min;
            }
            if (data.data.budget_max) {
                document.getElementById('id_budget_max').value = data.data.budget_max;
            }

            alert('Información extraída correctamente. Revisa y ajusta los campos si es necesario.');
        } else {
            alert('Error: ' + (data.message || 'No se pudo extraer la información'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al procesar la solicitud. Por favor, intenta de nuevo.');
    } finally {
        btn.disabled = false;
        spinner.classList.remove('active');
        btn.textContent = 'Autocompletar campos';
    }
});
</script>
{% endblock %}
